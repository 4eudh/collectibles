<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collectible Realm</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui'],
                        display: ['Space Grotesk', 'Inter', 'system-ui']
                    },
                    colors: {
                        midnight: {
                            50: '#F1F5FF',
                            100: '#D4DEFF',
                            200: '#A0B7FF',
                            300: '#708FFE',
                            400: '#4B6EFE',
                            500: '#274DFE',
                            600: '#1C3ECC',
                            700: '#142E99',
                            800: '#0C1F66',
                            900: '#061133'
                        },
                        nebula: '#7F5BFF',
                        aurora: '#00F5A0',
                        starlight: '#FF9D66',
                        obsidian: '#0B1021'
                    },
                    boxShadow: {
                        glow: '0 25px 50px -12px rgba(127, 91, 255, 0.45)',
                        card: '0 20px 45px -20px rgba(13, 19, 33, 0.45)'
                    },
                    backgroundImage: {
                        'grid-glow': 'radial-gradient(circle at 20% 20%, rgba(127,91,255,0.25), transparent 35%), radial-gradient(circle at 80% 0%, rgba(0,245,160,0.2), transparent 40%), radial-gradient(circle at 50% 80%, rgba(255,157,102,0.2), transparent 45%)'
                    },
                    animation: {
                        gradient: 'gradientShift 18s ease infinite',
                        float: 'float 6s ease-in-out infinite',
                        shimmer: 'shimmer 1.8s linear infinite'
                    },
                    keyframes: {
                        gradientShift: {
                            '0%': { backgroundPosition: '0% 50%' },
                            '50%': { backgroundPosition: '100% 50%' },
                            '100%': { backgroundPosition: '0% 50%' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-12px)' }
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-100% 0' },
                            '100%': { backgroundPosition: '100% 0' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            color-scheme: light dark;
        }

        body {
            font-feature-settings: "cv02", "cv03", "cv04", "cv09";
        }

        .glass-surface {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(18px);
        }

        .dark .glass-surface {
            background: rgba(13, 19, 33, 0.6);
        }

        .border-gradient {
            position: relative;
        }

        .border-gradient::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            padding: 1px;
            background: linear-gradient(120deg, rgba(127, 91, 255, 0.75), rgba(0, 245, 160, 0.75), rgba(255, 157, 102, 0.75));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
        }

        .rarity-pill {
            background: linear-gradient(120deg, rgba(127,91,255,0.18), rgba(0,245,160,0.18));
        }

        .dark .rarity-pill {
            background: linear-gradient(120deg, rgba(127,91,255,0.22), rgba(0,245,160,0.22));
        }

        .grid-overlay::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: linear-gradient(rgba(255, 255, 255, 0.04) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.04) 1px, transparent 1px);
            background-size: 48px 48px;
            pointer-events: none;
            opacity: 0.7;
        }

        .dark .grid-overlay::after {
            background-image: linear-gradient(rgba(0, 0, 0, 0.2) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 0, 0, 0.2) 1px, transparent 1px);
        }

        .shimmer {
            background-image: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.45) 50%, rgba(255,255,255,0) 100%);
            background-size: 200% 100%;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="min-h-full bg-midnight-900 text-slate-100">
    <div class="min-h-screen bg-grid-glow grid-overlay">
        <div class="min-h-screen flex flex-col backdrop-blur-xl bg-gradient-to-b from-white/70 via-white/60 to-white/30 dark:from-obsidian/80 dark:via-obsidian/60 dark:to-obsidian/40">
            <header class="px-6 lg:px-12 py-6">
                <div class="max-w-7xl mx-auto flex flex-col lg:flex-row lg:items-center gap-6">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-nebula via-starlight to-aurora shadow-glow flex items-center justify-center text-2xl font-display text-obsidian">
                            ✦
                        </div>
                        <div>
                            <p class="uppercase tracking-[0.35em] text-xs font-semibold text-slate-500 dark:text-slate-400">Collectible Realm</p>
                            <h1 class="text-3xl lg:text-4xl font-display font-semibold text-obsidian dark:text-white">Master the Multiverse of Treasures</h1>
                        </div>
                    </div>
                    <nav class="flex-1">
                        <ul class="flex flex-wrap items-center gap-2 lg:justify-end">
                            <li><button data-nav="dashboard" class="nav-link px-4 py-2 rounded-full font-medium text-sm glass-surface border border-white/10 hover:border-white/40 transition">Dashboard</button></li>
                            <li><button data-nav="collection" class="nav-link px-4 py-2 rounded-full font-medium text-sm glass-surface border border-white/10 hover:border-white/40 transition">Collection</button></li>
                            <li><button data-nav="redeem" class="nav-link px-4 py-2 rounded-full font-medium text-sm glass-surface border border-white/10 hover:border-white/40 transition">Redeem</button></li>
                            <li><button data-nav="marketplace" class="nav-link px-4 py-2 rounded-full font-medium text-sm glass-surface border border-white/10 hover:border-white/40 transition">Marketplace</button></li>
                            <li><button data-nav="quests" class="nav-link px-4 py-2 rounded-full font-medium text-sm glass-surface border border-white/10 hover:border-white/40 transition">Quests</button></li>
                            <li><button data-nav="admin" class="nav-link px-4 py-2 rounded-full font-medium text-sm glass-surface border border-white/10 hover:border-white/40 transition">Admin</button></li>
                        </ul>
                    </nav>
                    <div class="flex items-center gap-3">
                        <button id="command-palette-toggle" class="hidden lg:inline-flex items-center gap-2 text-xs uppercase tracking-[0.35em] text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 transition">
                            ⌘K Command Palette
                        </button>
                    </div>
                    <div class="mt-4 text-center text-sm">
                        <a href="#" id="showRegisterForm" class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400">Don't have an account? Register</a>
                    </div>
                </div>
                
                <!-- Register Form -->
                <div id="registerForm" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 hidden">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Create Account</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="registerUsername" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Username</label>
                            <input type="text" id="registerUsername" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm dark:bg-gray-700 dark:text-white text-base focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div>
                            <label for="registerEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
                            <input type="email" id="registerEmail" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm dark:bg-gray-700 dark:text-white text-base focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div>
                            <label for="registerPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
                            <input type="password" id="registerPassword" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm dark:bg-gray-700 dark:text-white text-base focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <button id="registerButton" class="w-full bg-primary-500 text-white py-2 px-4 rounded-md hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors flex items-center justify-center">
                            <span id="registerButtonText">Register</span>
                            <div id="registerButtonSpinner" class="loading-spinner ml-2 hidden"></div>
                        </button>
                    </div>
                    <div class="mt-4 text-center text-sm">
                        <a href="#" id="showLoginForm" class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400">Already have an account? Sign in</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex">
                        <div class="flex-shrink-0 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary-500" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5 5a3 3 0 015-2.236A3 3 0 0114.83 6H16a2 2 0 110 4h-5V9a1 1 0 10-2 0v1H4a2 2 0 110-4h1.17A3 3 0 015 5zm4 1V5a1 1 0 10-1 1h1zm3 0a1 1 0 10-1-1v1h1z" clip-rule="evenodd" />
                                <path d="M9 11H3v5a2 2 0 002 2h4v-7zM11 18h4a2 2 0 002-2v-5h-6v7z" />
                            </svg>
                            <h1 class="ml-2 text-xl font-bold text-gray-900 dark:text-white">Collectible Realm</h1>
                        </div>
                        <nav class="hidden md:ml-6 md:flex md:space-x-8">
                            <a href="#" id="nav-dashboard" class="border-primary-500 text-gray-900 dark:text-white hover:text-primary-500 dark:hover:text-primary-400 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Dashboard</a>
                            <a href="#" id="nav-collection" class="border-transparent text-gray-500 dark:text-gray-300 hover:border-gray-300 dark:hover:border-gray-600 hover:text-gray-700 dark:hover:text-gray-200 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">My Collection</a>
                            <a href="#" id="nav-redeem" class="border-transparent text-gray-500 dark:text-gray-300 hover:border-gray-300 dark:hover:border-gray-600 hover:text-gray-700 dark:hover:text-gray-200 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Redeem Code</a>
                            <a href="#" id="nav-marketplace" class="border-transparent text-gray-500 dark:text-gray-300 hover:border-gray-300 dark:hover:border-gray-600 hover:text-gray-700 dark:hover:text-gray-200 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Marketplace</a>
                        </nav>
                    </div>
                    <div class="hidden md:ml-6 md:flex md:items-center">
                        <button id="headerDarkModeToggle" class="p-1 rounded-full text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-gray-800">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                            </svg>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 block dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                            </svg>
                        </button>
                        <button id="user-menu-trigger" class="px-4 py-2 rounded-full glass-surface border border-white/10 text-sm font-medium flex items-center gap-2 hover:border-white/40 transition">
                            <span class="user-name">Guest</span>
                            <span class="text-lg">▼</span>
                        </button>
                    </div>
                </div>
            </div>
            <div id="mobileMenu" class="hidden md:hidden">
                <div class="pt-2 pb-3 space-y-1">
                    <a href="#" id="mobile-nav-dashboard" class="bg-primary-50 dark:bg-primary-900 border-primary-500 text-primary-700 dark:text-primary-300 block pl-3 pr-4 py-2 border-l-4 text-base font-medium">Dashboard</a>
                    <a href="#" id="mobile-nav-collection" class="border-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:border-gray-300 dark:hover:border-gray-600 hover:text-gray-800 dark:hover:text-white block pl-3 pr-4 py-2 border-l-4 text-base font-medium">My Collection</a>
                    <a href="#" id="mobile-nav-redeem" class="border-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:border-gray-300 dark:hover:border-gray-600 hover:text-gray-800 dark:hover:text-white block pl-3 pr-4 py-2 border-l-4 text-base font-medium">Redeem Code</a>
                    <a href="#" id="mobile-nav-marketplace" class="border-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:border-gray-300 dark:hover:border-gray-600 hover:text-gray-800 dark:hover:text-white block pl-3 pr-4 py-2 border-l-4 text-base font-medium">Marketplace</a>
                </div>
                <div class="pt-4 pb-3 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex items-center px-4">
                        <div class="flex-shrink-0">
                            <div class="h-10 w-10 rounded-full bg-primary-200 dark:bg-primary-800 flex items-center justify-center">
                                <span id="mobileUserInitial" class="text-primary-700 dark:text-primary-300 font-medium">U</span>
                            </div>
                        </div>
                        <div class="ml-3">
                            <div id="mobileUsername" class="text-base font-medium text-gray-800 dark:text-white">User</div>
                            <div id="mobileUserEmail" class="text-sm font-medium text-gray-500 dark:text-gray-400">user@example.com</div>
                        </div>
                        <button id="mobileDarkModeToggle" class="ml-auto bg-gray-100 dark:bg-gray-700 flex-shrink-0 p-1 rounded-full text-gray-400 dark:text-gray-300 hover:text-gray-500 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-gray-800">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                            </svg>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 block dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                            </svg>
                        </button>
                    </div>
                    <div class="mt-3 space-y-1">
                        <a href="#" id="mobile-menu-profile" class="block px-4 py-2 text-base font-medium text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700">Your Profile</a>
                        <a href="#" id="mobile-menu-settings" class="block px-4 py-2 text-base font-medium text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700">Settings</a>
                        <a href="#" id="mobile-menu-admin-panel" class="block px-4 py-2 text-base font-medium text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 hidden">Admin Panel</a>
                        <a href="#" id="mobile-menu-sign-out" class="block px-4 py-2 text-base font-medium text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700">Sign out</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow">
            <!-- Dashboard -->
            <div id="dashboardView" class="py-6">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">Dashboard</h1>
                    <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">Chart your journey across the realm with live progress, quests, and seasonal highlights.</p>
                    <div class="mt-6 grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5">
                        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg transition-all duration-300 hover:shadow-xl">
                            <div class="px-4 py-5 sm:p-6">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 bg-primary-100 dark:bg-primary-900 rounded-md p-3">
                                        <svg class="h-6 w-6 text-primary-600 dark:text-primary-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                        </svg>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Total Collectibles</dt>
                                            <dd>
                                                <div id="totalCollectibles" class="text-lg font-medium text-gray-900 dark:text-white">0</div>
                                            </dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg transition-all duration-300 hover:shadow-xl">
                            <div class="px-4 py-5 sm:p-6">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 bg-yellow-100 dark:bg-yellow-900 rounded-md p-3">
                                        <svg class="h-6 w-6 text-yellow-600 dark:text-yellow-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3-1.343 3-3S13.657 2 12 2 9 3.343 9 5s1.343 3 3 3zm0 2c-3.314 0-6 2.239-6 5v2h12v-2c0-2.761-2.686-5-6-5z" />
                                        </svg>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Realm Gold</dt>
                                            <dd>
                                                <div id="realmGoldBalance" class="text-lg font-medium text-gray-900 dark:text-white">0</div>
                                            </dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg transition-all duration-300 hover:shadow-xl">
                            <div class="px-4 py-5 sm:p-6">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 bg-purple-100 dark:bg-purple-900 rounded-md p-3">
                                        <svg class="h-6 w-6 text-purple-600 dark:text-purple-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c1.657 0 3-1.343 3-3S13.657 5 12 5 9 6.343 9 8s1.343 3 3 3zm0 2c-3.314 0-6 2.239-6 5v1h12v-1c0-2.761-2.686-5-6-5z" />
                                        </svg>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Stellar Gems</dt>
                                            <dd>
                                                <div id="stellarGemBalance" class="text-lg font-medium text-gray-900 dark:text-white">0</div>
                                            </dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg transition-all duration-300 hover:shadow-xl">
                            <div class="px-4 py-5 sm:p-6">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 bg-primary-100 dark:bg-primary-900 rounded-md p-3">
                                        <svg class="h-6 w-6 text-primary-600 dark:text-primary-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Collectibles Redeemed</dt>
                                            <dd>
                                                <div id="redeemedCollectibles" class="text-lg font-medium text-gray-900 dark:text-white">0</div>
                                            </dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg transition-all duration-300 hover:shadow-xl">
                            <div class="px-4 py-5 sm:p-6">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 bg-primary-100 dark:bg-primary-900 rounded-md p-3">
                                        <svg class="h-6 w-6 text-primary-600 dark:text-primary-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                                        </svg>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Rarest Collectible</dt>
                                            <dd>
                                                <div id="rarestCollectible" class="text-lg font-medium text-gray-900 dark:text-white">None</div>
                                            </dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-medium text-gray-900 dark:text-white">Realm Progression</h2>
                            <span id="progressionSummary" class="text-sm text-gray-500 dark:text-gray-400 hidden"></span>
                        </div>
                        <div id="progressionOverviewCard" class="mt-4 bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                            <div class="text-sm text-gray-500 dark:text-gray-400">Progress data will appear once you start redeeming codes.</div>
                        </div>
                    </div>

                    <div class="mt-8 grid grid-cols-1 xl:grid-cols-3 gap-6">
                        <div class="xl:col-span-2 space-y-8">
                            <div>
                                <div class="flex items-center justify-between">
                                    <h2 class="text-lg font-medium text-gray-900 dark:text-white">Daily Quest Board</h2>
                                    <span id="questResetCountdown" class="text-xs font-medium uppercase tracking-wide text-gray-500 dark:text-gray-400">Resets in --:--</span>
                                </div>
                                <div id="questBoard" class="mt-4 grid grid-cols-1 gap-4 md:grid-cols-2">
                                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-sm text-gray-500 dark:text-gray-400">
                                        Daily quests refresh with tasks tailored to your playstyle. Redeem codes to see them here.
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h2 class="text-lg font-medium text-gray-900 dark:text-white">Achievement Showcase</h2>
                                <div id="achievementShowcase" class="mt-4 grid grid-cols-1 gap-4 md:grid-cols-2">
                                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-sm text-gray-500 dark:text-gray-400">
                                        Earn achievements by collecting items, keeping streaks, and discovering rare treasures.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-8">
                            <div>
                                <h2 class="text-lg font-medium text-gray-900 dark:text-white">Recent Activity</h2>
                                <div class="mt-2 bg-white dark:bg-gray-800 shadow overflow-hidden rounded-lg">
                                    <ul id="activityFeed" class="divide-y divide-gray-200 dark:divide-gray-700">
                                        <li class="px-4 py-4 flex text-gray-500 dark:text-gray-400 italic">No recent activity to display</li>
                                    </ul>
                                </div>
                            </div>
                            <div>
                                <h2 class="text-lg font-medium text-gray-900 dark:text-white">Seasonal Spotlight</h2>
                                <div id="seasonShowcase" class="mt-2 space-y-4">
                                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-sm text-gray-500 dark:text-gray-400">
                                        Seasonal events and spotlights will appear here to guide your next adventure.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8">
                        <h2 class="text-lg font-medium text-gray-900 dark:text-white">Featured Collectibles</h2>
                        <div class="mt-4 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
                            <div id="featuredCollectibles" class="col-span-full text-center p-8 text-gray-500 dark:text-gray-400 italic">
                                No featured collectibles to display
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Collection View -->
            <div id="collectionView" class="py-6 hidden">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                        <div>
                            <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">My Collection</h1>
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Browse all your collected items</p>
                        </div>
                        <div class="mt-4 md:mt-0">
                            <div class="flex items-center space-x-2">
                                <label for="collectionFilterRarity" class="text-sm font-medium text-gray-700 dark:text-gray-300">Filter:</label>
                                <select id="collectionFilterRarity" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 rounded-md shadow-sm dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm">
                                    <option value="all">All Rarities</option>
                                    <option value="common">Common</option>
                                    <option value="uncommon">Uncommon</option>
                                    <option value="rare">Rare</option>
                                    <option value="epic">Epic</option>
                                    <option value="legendary">Legendary</option>
                                    <option value="mythic">Mythic</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <div id="collectionStats" class="grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-6 mb-6">
                            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                                <div class="px-4 py-3">
                                    <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Common</div>
                                    <div class="mt-1 text-lg font-semibold text-gray-900 dark:text-white">0</div>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                                <div class="px-4 py-3">
                                    <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Uncommon</div>
                                    <div class="mt-1 text-lg font-semibold text-gray-900 dark:text-white">0</div>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                                <div class="px-4 py-3">
                                    <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Rare</div>
                                    <div class="mt-1 text-lg font-semibold text-gray-900 dark:text-white">0</div>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                                <div class="px-4 py-3">
                                    <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Epic</div>
                                    <div class="mt-1 text-lg font-semibold text-gray-900 dark:text-white">0</div>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                                <div class="px-4 py-3">
                                    <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Legendary</div>
                                    <div class="mt-1 text-lg font-semibold text-gray-900 dark:text-white">0</div>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                                <div class="px-4 py-3">
                                    <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Mythic</div>
                                    <div class="mt-1 text-lg font-semibold text-gray-900 dark:text-white">0</div>
                                </div>
                            </div>
                        </div>

                        <div id="collectionGrid" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
                            <div class="col-span-full text-center p-8 text-gray-500 dark:text-gray-400 italic">
                                Your collection is empty. Redeem a code to get started!
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Redeem Code View -->
            <div id="redeemCodeView" class="py-6 hidden">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">Redeem Code</h1>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Enter a code to add items to your collection</p>
                    
                    <div class="mt-6 bg-white dark:bg-gray-800 shadow overflow-hidden rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="max-w-xl mx-auto">
                                <div class="flex flex-col space-y-4">
                                    <label for="redeemCode" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Redemption Code</label>
                                    <div class="mt-1 flex rounded-md shadow-sm">
                                        <input type="text" id="redeemCode" class="focus:ring-primary-500 focus:border-primary-500 flex-1 block w-full rounded-md sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-base" placeholder="Enter your code here">
                                    </div>
                                    <div>
                                        <button id="redeemCodeButton" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-gray-800">
                                            <span id="redeemCodeButtonText">Redeem Code</span>
                                            <div id="redeemCodeButtonSpinner" class="loading-spinner ml-2 hidden"></div>
                                        </button>
                                    </div>
                                    <div id="redeemResult" class="hidden mt-4 p-4 rounded-md"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <h2 class="text-lg font-medium text-gray-900 dark:text-white">Redemption History</h2>
                        <div class="mt-2 bg-white dark:bg-gray-800 shadow overflow-hidden rounded-lg">
                            <div class="shadow overflow-hidden border-b border-gray-200 dark:border-gray-700 sm:rounded-lg">
                                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                    <thead class="bg-gray-50 dark:bg-gray-900">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Date</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Items</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Rarity</th>
                                        </tr>
                                    </thead>
                                    <tbody id="redemptionHistory" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                        <tr>
                                            <td colspan="3" class="px-6 py-4 whitespace-nowrap text-center text-gray-500 dark:text-gray-400 italic">No redemption history</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Marketplace View -->
            <div id="marketplaceView" class="py-6 hidden">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                        <div>
                            <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">Marketplace &amp; Economy</h1>
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Manage your currencies, post listings, and scout rare finds across the realm.</p>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button id="claimStipendButton" class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium bg-primary-600 text-white shadow-sm hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-gray-800 transition-colors">
                                Claim Daily Stipend
                            </button>
                            <button id="convertDuplicatesButton" class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium bg-white text-gray-700 dark:bg-gray-800 dark:text-gray-200 border border-gray-300 dark:border-gray-600 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-gray-800 transition-colors">
                                Convert Duplicates
                            </button>
                        </div>
                    </div>

                    <div id="walletSummaryCards" class="mt-6 grid grid-cols-1 gap-5 sm:grid-cols-2 xl:grid-cols-4">
                        <!-- Wallet summary cards will be rendered here -->
                    </div>

                    <div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <section id="economyPulsePanel" class="lg:col-span-2 bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                            <div class="text-sm text-gray-500 dark:text-gray-400">Economy data will appear once your profile loads.</div>
                        </section>
                        <section class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                            <div class="flex items-center justify-between">
                                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Ledger</h2>
                                <span class="text-xs uppercase tracking-wide text-gray-400 dark:text-gray-500">Latest 20</span>
                            </div>
                            <div id="economyLedger" class="mt-4 space-y-4 max-h-80 overflow-y-auto pr-1">
                                <p class="text-sm text-gray-500 dark:text-gray-400">Complete actions to populate your ledger.</p>
                            </div>
                        </section>
                    </div>

                    <div class="mt-10 grid grid-cols-1 xl:grid-cols-3 gap-8">
                        <section class="xl:col-span-2">
                            <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                    <div>
                                        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Active Listings</h2>
                                        <p id="marketStatsSummary" class="text-sm text-gray-500 dark:text-gray-400">Marketplace insights appear after syncing.</p>
                                    </div>
                                    <div class="flex flex-wrap gap-3">
                                        <select id="marketFilterRarity" class="block w-full sm:w-auto rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200 text-sm focus:ring-primary-500 focus:border-primary-500">
                                            <option value="all">All Rarities</option>
                                            <option value="common">Common</option>
                                            <option value="uncommon">Uncommon</option>
                                            <option value="rare">Rare</option>
                                            <option value="epic">Epic</option>
                                            <option value="legendary">Legendary</option>
                                            <option value="mythic">Mythic</option>
                                        </select>
                                        <select id="marketFilterCurrency" class="block w-full sm:w-auto rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200 text-sm focus:ring-primary-500 focus:border-primary-500">
                                            <option value="all">All Currencies</option>
                                            <option value="gold">Realm Gold</option>
                                            <option value="gems">Stellar Gems</option>
                                            <option value="premium">Premium Offers</option>
                                        </select>
                                        <select id="marketFilterSort" class="block w-full sm:w-auto rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200 text-sm focus:ring-primary-500 focus:border-primary-500">
                                            <option value="recent">Newest</option>
                                            <option value="value">Highest Value</option>
                                            <option value="rarity">Rarity</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="marketplaceListings" class="mt-6 grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-3">
                                    <div class="col-span-full text-sm text-gray-500 dark:text-gray-400 text-center py-6">Marketplace listings will populate soon.</div>
                                </div>
                            </div>
                        </section>
                        <aside class="space-y-6">
                            <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Listable Duplicates</h3>
                                    <button id="refreshMarketplaceSuggestions" class="text-sm font-medium text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300 focus:outline-none">Refresh</button>
                                </div>
                                <div id="suggestedListings" class="mt-4 space-y-4">
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Redeem or trade to discover duplicates ready for the market.</p>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Your Listings</h3>
                                    <span class="text-xs uppercase tracking-wide text-gray-400 dark:text-gray-500">Local preview</span>
                                </div>
                                <div id="playerListings" class="mt-4 space-y-4">
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Post a duplicate to start your trading career.</p>
                                </div>
                            </div>
                        </aside>
                    </div>
                </div>
            </div>

            <!-- Admin Panel -->
            <div id="adminPanelView" class="py-6 hidden">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                        <div>
                            <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">Admin Panel</h1>
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Manage codes, collectibles, and users</p>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <div class="bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-lg">
                            <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
                                <div>
                                    <h2 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Redemption Codes</h2>
                                    <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">Create and manage redemption codes</p>
                                </div>
                                <button id="createCodeButton" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-gray-800">
                                    Create New Code
                                </button>
                            </div>
                            <div class="border-t border-gray-200 dark:border-gray-700 px-4 py-5 sm:px-6">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-900">
                                            <tr>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Code</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Item</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Rarity</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Expires</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="codesTable" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            <tr>
                                                <td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-gray-500 dark:text-gray-400 italic">No codes created yet</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <div class="bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-lg">
                            <div class="px-4 py-5 sm:px-6">
                                <h2 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">User Management</h2>
                                <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">View and manage user accounts</p>
                            </div>
                            <div class="border-t border-gray-200 dark:border-gray-700 px-4 py-5 sm:px-6">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-900">
                                            <tr>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Username</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Email</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Role</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Collectibles</th>
                                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersTable" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            <tr>
                                                <td colspan="5" class="px-6 py-4 whitespace-nowrap text-center text-gray-500 dark:text-gray-400 italic">No users found</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile View -->
            <div id="profileView" class="py-6 hidden">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">Your Profile</h1>
                    
                    <div class="mt-6 bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-lg">
                        <div class="px-4 py-5 sm:px-6 flex items-center justify-between">
                            <div>
                                <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Profile Information</h3>
                                <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">Personal details and preferences</p>
                            </div>
                            <div class="h-16 w-16 rounded-full bg-primary-200 dark:bg-primary-800 flex items-center justify-center">
                                <span id="profileUserInitial" class="text-primary-700 dark:text-primary-300 text-2xl font-medium">U</span>
                            </div>
                        </div>
                        <div class="border-t border-gray-200 dark:border-gray-700">
                            <dl>
                                <div class="bg-gray-50 dark:bg-gray-900 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Username</dt>
                                    <dd class="mt-1 text-sm text-gray-900 dark:text-white sm:mt-0 sm:col-span-2" id="profileUsername">-</dd>
                                </div>
                                <div class="bg-white dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Email address</dt>
                                    <dd class="mt-1 text-sm text-gray-900 dark:text-white sm:mt-0 sm:col-span-2" id="profileEmail">-</dd>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-900 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Role</dt>
                                    <dd class="mt-1 text-sm text-gray-900 dark:text-white sm:mt-0 sm:col-span-2" id="profileRole">-</dd>
                                </div>
                                <div class="bg-white dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Collectibles</dt>
                                    <dd class="mt-1 text-sm text-gray-900 dark:text-white sm:mt-0 sm:col-span-2" id="profileCollectibles">0</dd>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-900 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Account created</dt>
                                    <dd class="mt-1 text-sm text-gray-900 dark:text-white sm:mt-0 sm:col-span-2" id="profileCreatedAt">-</dd>
                                </div>
                            </dl>
                        </div>
                    </div>

                    <div class="mt-6 bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-lg">
                        <div class="px-4 py-5 sm:px-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Update Profile</h3>
                            <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">Update your personal information</p>
                        </div>
                        <div class="border-t border-gray-200 dark:border-gray-700 px-4 py-5 sm:px-6">
                            <div class="space-y-6">
                                <div>
                                    <label for="updateUsername" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Username</label>
                                    <input type="text" id="updateUsername" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm dark:bg-gray-700 dark:text-white text-base focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                                </div>
                                <div>
                                    <button id="updateProfileButton" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-gray-800">
                                        <span id="updateProfileButtonText">Update Profile</span>
                                        <div id="updateProfileButtonSpinner" class="loading-spinner ml-2 hidden"></div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <main id="view-container" class="flex-1 px-6 lg:px-12 pb-24">
                <div class="max-w-7xl mx-auto grid gap-8" id="loading-shell">
                    <div class="glass-surface border-gradient rounded-3xl p-8 shadow-card">
                        <div class="h-32 rounded-2xl shimmer bg-white/10"></div>
                    </div>
                    <div class="grid lg:grid-cols-2 gap-6">
                        <div class="glass-surface border-gradient rounded-3xl p-8 shadow-card h-56"></div>
                        <div class="glass-surface border-gradient rounded-3xl p-8 shadow-card h-56"></div>
                    </div>
                </div>
            </main>

            <footer class="px-6 lg:px-12 py-10">
                <div class="max-w-7xl mx-auto flex flex-col lg:flex-row gap-4 lg:items-center justify-between text-sm text-slate-500 dark:text-slate-400">
                    <p>&copy; <span id="footer-year"></span> Collectible Realm. Crafted for treasure hunters.</p>
                    <div class="flex flex-wrap gap-3 items-center">
                        <span class="glass-surface border border-white/10 rounded-full px-3 py-1">Version <span id="app-version">0.0.0</span></span>
                        <span class="glass-surface border border-white/10 rounded-full px-3 py-1" id="status-pill">Status pending</span>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <template id="toast-template">
        <div class="toast glass-surface border border-white/20 shadow-lg rounded-2xl px-4 py-3 text-sm flex items-start gap-3 w-full max-w-sm">
            <div class="toast-icon text-lg">✨</div>
            <div>
                <p class="toast-title font-semibold"></p>
                <p class="toast-message text-slate-400"></p>
            </div>
            <button class="toast-close ml-auto text-xs uppercase tracking-[0.2em] text-slate-400">Close</button>
        </div>
    </template>

        <div id="confirmationModal" class="fixed inset-0 overflow-y-auto hidden z-50">
            <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                    <div class="absolute inset-0 bg-gray-500 dark:bg-gray-900 opacity-75"></div>
                </div>
                <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                    <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900 sm:mx-0 sm:h-10 sm:w-10">
                                <svg class="h-6 w-6 text-red-600 dark:text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                            </div>
                            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="confirmation-modal-title">
                                    Delete Item
                                </h3>
                                <div class="mt-2">
                                    <p class="text-sm text-gray-500 dark:text-gray-400" id="confirmation-modal-message">
                                        Are you sure you want to delete this item? This action cannot be undone.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-900 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button id="confirmActionButton" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                            Delete
                        </button>
                        <button id="cancelActionButton" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="notificationContainer" class="fixed inset-x-0 top-0 flex items-end justify-center px-4 py-6 pointer-events-none sm:p-6 sm:items-start sm:justify-end z-50">
            <!-- Notifications will be dynamically added here -->
        </div>
    </div>

    <script>
        // REPLACE THESE WITH YOUR ACTUAL SUPABASE CREDENTIALS
        const SUPABASE_URL = 'https://pipaigpzmbdymsxgvgwa.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBpcGFpZ3B6bWJkeW1zeGd2Z3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzNTYzMDEsImV4cCI6MjA2NDkzMjMwMX0.SHA-bOF5Z2q9vWf571AUerZy_-_F2XeV-l-mn6fvcLU';

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ==================== Module: Registry ====================
        const AppModules = (() => {
            const modules = new Map();

            return {
                define(name, factory) {
                    if (modules.has(name)) {
                        console.warn(`[AppModules] Module "${name}" already defined. Returning existing instance.`);
                        return modules.get(name);
                    }

                    const module = typeof factory === 'function' ? factory() : factory;
                    modules.set(name, module);
                    return module;
                },
                use(name) {
                    if (!modules.has(name)) {
                        throw new Error(`[AppModules] Unknown module: ${name}`);
                    }
                    return modules.get(name);
                },
                list() {
                    return Array.from(modules.keys());
                }
            };
        })();

        window.__APP_MODULES__ = AppModules;

        // ==================== Module: State Store ====================
        function createReactiveState(initialState = {}) {
            const listeners = new Set();
            const proxyCache = new WeakMap();
            let activeDescription = null;

            const notify = (path, value, previousValue) => {
                const payload = {
                    path,
                    value,
                    previous: previousValue,
                    state: rootProxy,
                    description: activeDescription || 'mutation'
                };

                listeners.forEach(listener => {
                    try {
                        listener(payload);
                    } catch (error) {
                        console.error('[AppState] Subscriber error', error);
                    }
                });
            };

            const wrap = (target, path = []) => {
                if (target && typeof target === 'object') {
                    if (proxyCache.has(target)) {
                        return proxyCache.get(target);
                    }

                    const proxy = new Proxy(target, {
                        get(obj, prop, receiver) {
                            const value = Reflect.get(obj, prop, receiver);
                            if (value && typeof value === 'object') {
                                return wrap(value, [...path, prop]);
                            }
                            return value;
                        },
                        set(obj, prop, value) {
                            const previousValue = obj[prop];
                            if (previousValue === value) {
                                return true;
                            }

                            const wrappedValue = value && typeof value === 'object'
                                ? wrap(value, [...path, prop])
                                : value;

                            obj[prop] = wrappedValue;
                            notify([...path, prop], wrappedValue, previousValue);
                            return true;
                        },
                        deleteProperty(obj, prop) {
                            if (!(prop in obj)) {
                                return true;
                            }
                            const previousValue = obj[prop];
                            delete obj[prop];
                            notify([...path, prop], undefined, previousValue);
                            return true;
                        }
                    });

                    proxyCache.set(target, proxy);
                    return proxy;
                }
                return target;
            };

            const rootProxy = wrap(initialState);

            return {
                state: rootProxy,
                subscribe(listener) {
                    listeners.add(listener);
                    return () => listeners.delete(listener);
                },
                setState(updater, description = 'update') {
                    activeDescription = description;
                    const partialState = typeof updater === 'function' ? updater(rootProxy) : updater;
                    if (partialState && typeof partialState === 'object') {
                        Object.entries(partialState).forEach(([key, value]) => {
                            rootProxy[key] = value;
                        });
                    }
                    activeDescription = null;
                    return rootProxy;
                }
            };
        }

        const prefersDarkScheme = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;
        const initialTheme = (prefersDarkScheme && prefersDarkScheme.matches) ? 'dark' : 'light';
        document.documentElement.classList.toggle('dark', initialTheme === 'dark');

        const stateStore = createReactiveState({
            currentUser: null,
            userProfile: null,
            codes: [],
            collectibles: [],
            currentView: 'dashboard',
            isAdmin: false,
            activities: [],
            redemptionHistory: [],
            users: [],
            theme: initialTheme,
            progression: null,
            quests: [],
            achievements: [],
            seasonEvents: [],
            journeyInsights: null
        });

        const appState = stateStore.state;

        if (prefersDarkScheme) {
            prefersDarkScheme.addEventListener('change', event => {
                stateStore.setState({ theme: event.matches ? 'dark' : 'light' }, 'theme:prefers-scheme');
            });
        }

        const Diagnostics = AppModules.define('diagnostics', () => {
            const history = [];
            const maxEntries = 50;

            function record(change) {
                history.push({ ...change, timestamp: Date.now() });
                if (history.length > maxEntries) {
                    history.shift();
                }

                if (window.__APP_DEBUG__) {
                    const label = change.path.length ? change.path.join('.') : '(root)';
                    console.info(`[AppState] ${change.description}`, label, change.value);
                }
            }

            function getHistory() {
                return [...history];
            }

            return {
                record,
                getHistory
            };
        });

        stateStore.subscribe(change => {
            Diagnostics.record(change);

            if (change.path[0] === 'theme' && change.path.length === 1 && change.value !== change.previous) {
                document.documentElement.classList.toggle('dark', change.value === 'dark');
            }
        });

        window.__APP_STORE__ = stateStore;
        window.__APP_DEBUG__ = window.__APP_DEBUG__ ?? false;

// WhatsApp-style Emoji Categories (compatible set)
// Structure preserved: { name, emoji, value }
const emojiCategories = {
  "Smileys & Emotion": [
    { name: "Grinning Face", emoji: "😀", value: "grinning_face" },
    { name: "Beaming Face", emoji: "😁", value: "beaming_face" },
    { name: "Face With Tears of Joy", emoji: "😂", value: "tears_of_joy" },
    { name: "Rolling on the Floor Laughing", emoji: "🤣", value: "rofl" },
    { name: "Slightly Smiling Face", emoji: "🙂", value: "slightly_smiling" },
    { name: "Winking Face", emoji: "😉", value: "winking_face" },
    { name: "Smiling Face With Smiling Eyes", emoji: "😊", value: "smiling_eyes" },
    { name: "Smiling Face With Heart-Eyes", emoji: "😍", value: "heart_eyes" },
    { name: "Face Blowing a Kiss", emoji: "😘", value: "kiss_blow" },
    { name: "Face Savoring Food", emoji: "😋", value: "savoring_food" },
    { name: "Smiling Face With Sunglasses", emoji: "😎", value: "sunglasses" },
    { name: "Thinking Face", emoji: "🤔", value: "thinking_face" },
    { name: "Neutral Face", emoji: "😐", value: "neutral_face" },
    { name: "Unamused Face", emoji: "😒", value: "unamused_face" },
    { name: "Pensive Face", emoji: "😔", value: "pensive_face" },
    { name: "Confused Face", emoji: "😕", value: "confused_face" },
    { name: "Face With Rolling Eyes", emoji: "🙄", value: "rolling_eyes" },
    { name: "Grinning Face With Sweat", emoji: "😅", value: "grinning_sweat" },
    { name: "Loudly Crying Face", emoji: "😭", value: "loudly_crying" },
    { name: "Astonished Face", emoji: "😲", value: "astonished_face" },
    { name: "Flushed Face", emoji: "😳", value: "flushed_face" },
    { name: "Exploding Head", emoji: "🤯", value: "exploding_head" },
    { name: "Shushing Face", emoji: "🤫", value: "shushing_face" },
    { name: "Face With Hand Over Mouth", emoji: "🤭", value: "hand_over_mouth" },
    { name: "Sleeping Face", emoji: "😴", value: "sleeping_face" },
    { name: "Drooling Face", emoji: "🤤", value: "drooling_face" },
    { name: "Angry Face", emoji: "😠", value: "angry_face" },
    { name: "Pouting Face", emoji: "😡", value: "pouting_face" },
    { name: "Face Screaming in Fear", emoji: "😱", value: "screaming_fear" },
    { name: "Hot Face", emoji: "🥵", value: "hot_face" },
    { name: "Cold Face", emoji: "🥶", value: "cold_face" },
    { name: "Partying Face", emoji: "🥳", value: "partying_face" },
    { name: "Pleading Face", emoji: "🥺", value: "pleading_face" },
    { name: "Face With Medical Mask", emoji: "😷", value: "medical_mask" }
  ],

  "People & Body": [
    { name: "Waving Hand", emoji: "👋", value: "waving_hand" },
    { name: "Raised Hand", emoji: "✋", value: "raised_hand" },
    { name: "OK Hand", emoji: "👌", value: "ok_hand" },
    { name: "Thumbs Up", emoji: "👍", value: "thumbs_up" },
    { name: "Thumbs Down", emoji: "👎", value: "thumbs_down" },
    { name: "Clapping Hands", emoji: "👏", value: "clapping_hands" },
    { name: "Raising Hands", emoji: "🙌", value: "raising_hands" },
    { name: "Folded Hands", emoji: "🙏", value: "folded_hands" },
    { name: "Victory Hand", emoji: "✌️", value: "victory_hand" },
    { name: "Call Me Hand", emoji: "🤙", value: "call_me_hand" },
    { name: "Backhand Index Pointing Right", emoji: "👉", value: "point_right" },
    { name: "Backhand Index Pointing Left", emoji: "👈", value: "point_left" },
    { name: "Backhand Index Pointing Up", emoji: "👆", value: "point_up" },
    { name: "Backhand Index Pointing Down", emoji: "👇", value: "point_down" },
    { name: "Flexed Biceps", emoji: "💪", value: "flexed_biceps" },
    { name: "Person", emoji: "🧑", value: "person" },
    { name: "Woman", emoji: "👩", value: "woman" },
    { name: "Man", emoji: "👨", value: "man" },
    { name: "Baby", emoji: "👶", value: "baby" },
    { name: "Person Walking", emoji: "🚶", value: "person_walking" },
    { name: "Person Running", emoji: "🏃", value: "person_running" },
    { name: "Person Biking", emoji: "🚴", value: "person_biking" },
    { name: "Person Lifting Weights", emoji: "🏋️", value: "person_lifting" },
    { name: "Person in Lotus Position", emoji: "🧘", value: "lotus_position" }
  ],

  "Animals & Nature": [
    { name: "Dog", emoji: "🐶", value: "dog" },
    { name: "Cat", emoji: "🐱", value: "cat" },
    { name: "Mouse", emoji: "🐭", value: "mouse" },
    { name: "Rabbit", emoji: "🐰", value: "rabbit" },
    { name: "Fox", emoji: "🦊", value: "fox" },
    { name: "Bear", emoji: "🐻", value: "bear" },
    { name: "Panda", emoji: "🐼", value: "panda" },
    { name: "Koala", emoji: "🐨", value: "koala" },
    { name: "Tiger", emoji: "🐯", value: "tiger" },
    { name: "Lion", emoji: "🦁", value: "lion" },
    { name: "Cow", emoji: "🐮", value: "cow" },
    { name: "Pig", emoji: "🐷", value: "pig" },
    { name: "Monkey", emoji: "🐵", value: "monkey" },
    { name: "Frog", emoji: "🐸", value: "frog" },
    { name: "Chicken", emoji: "🐔", value: "chicken" },
    { name: "Penguin", emoji: "🐧", value: "penguin" },
    { name: "Bird", emoji: "🐦", value: "bird" },
    { name: "Eagle", emoji: "🦅", value: "eagle" },
    { name: "Duck", emoji: "🦆", value: "duck" },
    { name: "Owl", emoji: "🦉", value: "owl" },
    { name: "Butterfly", emoji: "🦋", value: "butterfly" },
    { name: "Honeybee", emoji: "🐝", value: "honeybee" },
    { name: "Lady Beetle", emoji: "🐞", value: "lady_beetle" },
    { name: "Turtle", emoji: "🐢", value: "turtle" },
    { name: "Snake", emoji: "🐍", value: "snake" },
    { name: "Octopus", emoji: "🐙", value: "octopus" },
    { name: "Tropical Fish", emoji: "🐠", value: "tropical_fish" },
    { name: "Dolphin", emoji: "🐬", value: "dolphin" },
    { name: "Whale", emoji: "🐳", value: "whale" },
    { name: "Spouting Whale", emoji: "🐋", value: "spouting_whale" },
    { name: "Palm Tree", emoji: "🌴", value: "palm_tree" },
    { name: "Cactus", emoji: "🌵", value: "cactus" },
    { name: "Sunflower", emoji: "🌻", value: "sunflower" },
    { name: "Rose", emoji: "🌹", value: "rose" },
    { name: "Seedling", emoji: "🌱", value: "seedling" },
    { name: "Maple Leaf", emoji: "🍁", value: "maple_leaf" },
    { name: "Cherry Blossom", emoji: "🌸", value: "cherry_blossom" },
    { name: "Fire", emoji: "🔥", value: "fire" },
    { name: "Sparkles", emoji: "✨", value: "sparkles" }
  ],

  "Food & Drink": [
    { name: "Red Apple", emoji: "🍎", value: "red_apple" },
    { name: "Green Apple", emoji: "🍏", value: "green_apple" },
    { name: "Grapes", emoji: "🍇", value: "grapes" },
    { name: "Watermelon", emoji: "🍉", value: "watermelon" },
    { name: "Strawberry", emoji: "🍓", value: "strawberry" },
    { name: "Pineapple", emoji: "🍍", value: "pineapple" },
    { name: "Banana", emoji: "🍌", value: "banana" },
    { name: "Peach", emoji: "🍑", value: "peach" },
    { name: "Avocado", emoji: "🥑", value: "avocado" },
    { name: "Tomato", emoji: "🍅", value: "tomato" },
    { name: "Carrot", emoji: "🥕", value: "carrot" },
    { name: "Corn", emoji: "🌽", value: "corn" },
    { name: "Bread", emoji: "🍞", value: "bread" },
    { name: "Croissant", emoji: "🥐", value: "croissant" },
    { name: "Cheese", emoji: "🧀", value: "cheese" },
    { name: "Egg", emoji: "🥚", value: "egg" },
    { name: "Cooking", emoji: "🍳", value: "cooking" },
    { name: "Pancakes", emoji: "🥞", value: "pancakes" },
    { name: "Hamburger", emoji: "🍔", value: "hamburger" },
    { name: "French Fries", emoji: "🍟", value: "french_fries" },
    { name: "Pizza", emoji: "🍕", value: "pizza" },
    { name: "Hot Dog", emoji: "🌭", value: "hot_dog" },
    { name: "Taco", emoji: "🌮", value: "taco" },
    { name: "Burrito", emoji: "🌯", value: "burrito" },
    { name: "Green Salad", emoji: "🥗", value: "green_salad" },
    { name: "Sushi", emoji: "🍣", value: "sushi" },
    { name: "Steaming Bowl", emoji: "🍜", value: "steaming_bowl" },
    { name: "Spaghetti", emoji: "🍝", value: "spaghetti" },
    { name: "Bento Box", emoji: "🍱", value: "bento" },
    { name: "Shortcake", emoji: "🍰", value: "shortcake" },
    { name: "Chocolate Bar", emoji: "🍫", value: "chocolate_bar" },
    { name: "Lollipop", emoji: "🍭", value: "lollipop" },
    { name: "Coffee", emoji: "☕", value: "coffee" },
    { name: "Tea", emoji: "🍵", value: "tea" },
    { name: "Beer Mug", emoji: "🍺", value: "beer" },
    { name: "Wine Glass", emoji: "🍷", value: "wine" },
    { name: "Tropical Drink", emoji: "🍹", value: "tropical_drink" },
    { name: "Clinking Glasses", emoji: "🥂", value: "clinking_glasses" }
  ],

  "Activities": [
    { name: "Soccer Ball", emoji: "⚽", value: "soccer" },
    { name: "Basketball", emoji: "🏀", value: "basketball" },
    { name: "Baseball", emoji: "⚾", value: "baseball" },
    { name: "Tennis", emoji: "🎾", value: "tennis" },
    { name: "Volleyball", emoji: "🏐", value: "volleyball" },
    { name: "Rugby Football", emoji: "🏉", value: "rugby" },
    { name: "Table Tennis", emoji: "🏓", value: "table_tennis" },
    { name: "Badminton", emoji: "🏸", value: "badminton" },
    { name: "Bowling", emoji: "🎳", value: "bowling" },
    { name: "Skateboard", emoji: "🛹", value: "skateboard" },
    { name: "Fishing Pole", emoji: "🎣", value: "fishing" },
    { name: "Skier", emoji: "⛷️", value: "skier" },
    { name: "Snowboarder", emoji: "🏂", value: "snowboarder" },
    { name: "Weight Lifter", emoji: "🏋️", value: "weight_lifter" },
    { name: "Person Bouncing Ball", emoji: "⛹️", value: "bouncing_ball" },
    { name: "Fencer", emoji: "🤺", value: "fencer" },
    { name: "Video Game", emoji: "🎮", value: "video_game" },
    { name: "Puzzle Piece", emoji: "🧩", value: "puzzle_piece" },
    { name: "Game Die", emoji: "🎲", value: "game_die" },
    { name: "Artist Palette", emoji: "🎨", value: "artist_palette" },
    { name: "Microphone", emoji: "🎤", value: "microphone" },
    { name: "Headphone", emoji: "🎧", value: "headphone" },
    { name: "Clapper Board", emoji: "🎬", value: "clapper_board" },
    { name: "Musical Notes", emoji: "🎶", value: "musical_notes" }
  ],

  "Travel & Places": [
    { name: "Automobile", emoji: "🚗", value: "automobile" },
    { name: "Taxi", emoji: "🚕", value: "taxi" },
    { name: "Bus", emoji: "🚌", value: "bus" },
    { name: "Police Car", emoji: "🚓", value: "police_car" },
    { name: "Ambulance", emoji: "🚑", value: "ambulance" },
    { name: "Fire Engine", emoji: "🚒", value: "fire_engine" },
    { name: "Bicycle", emoji: "🚲", value: "bicycle" },
    { name: "Motorcycle", emoji: "🏍️", value: "motorcycle" },
    { name: "Airplane", emoji: "✈️", value: "airplane" },
    { name: "Rocket", emoji: "🚀", value: "rocket" },
    { name: "Sailboat", emoji: "⛵", value: "sailboat" },
    { name: "Ship", emoji: "🚢", value: "ship" },
    { name: "High-Speed Train", emoji: "🚄", value: "high_speed_train" },
    { name: "Metro", emoji: "🚇", value: "metro" },
    { name: "Station", emoji: "🚉", value: "station" },
    { name: "Map", emoji: "🗺️", value: "world_map" },
    { name: "Mount Fuji", emoji: "🗻", value: "mount_fuji" },
    { name: "Volcano", emoji: "🌋", value: "volcano" },
    { name: "Beach With Umbrella", emoji: "🏖️", value: "beach_umbrella" },
    { name: "National Park", emoji: "🏞️", value: "national_park" },
    { name: "House", emoji: "🏠", value: "house" },
    { name: "Office Building", emoji: "🏢", value: "office_building" },
    { name: "Hospital", emoji: "🏥", value: "hospital" },
    { name: "Classical Building", emoji: "🏛️", value: "classical_building" },
    { name: "Church", emoji: "⛪", value: "church" },
    { name: "Mosque", emoji: "🕌", value: "mosque" },
    { name: "Synagogue", emoji: "🕍", value: "synagogue" },
    { name: "Shinto Shrine", emoji: "⛩️", value: "shinto_shrine" },
    { name: "Statue of Liberty", emoji: "🗽", value: "statue_of_liberty" },
    { name: "Tokyo Tower", emoji: "🗼", value: "tokyo_tower" }
  ],

  "Objects": [
    { name: "Watch", emoji: "⌚", value: "watch" },
    { name: "Mobile Phone", emoji: "📱", value: "mobile_phone" },
    { name: "Laptop", emoji: "💻", value: "laptop" },
    { name: "Desktop Computer", emoji: "🖥️", value: "desktop_computer" },
    { name: "Keyboard", emoji: "⌨️", value: "keyboard" },
    { name: "Computer Mouse", emoji: "🖱️", value: "computer_mouse" },
    { name: "Television", emoji: "📺", value: "television" },
    { name: "Camera", emoji: "📷", value: "camera" },
    { name: "Video Camera", emoji: "📹", value: "video_camera" },
    { name: "Light Bulb", emoji: "💡", value: "light_bulb" },
    { name: "Flashlight", emoji: "🔦", value: "flashlight" },
    { name: "Candle", emoji: "🕯️", value: "candle" },
    { name: "Battery", emoji: "🔋", value: "battery" },
    { name: "Electric Plug", emoji: "🔌", value: "electric_plug" },
    { name: "Hammer", emoji: "🔨", value: "hammer" },
    { name: "Wrench", emoji: "🔧", value: "wrench" },
    { name: "Gear", emoji: "⚙️", value: "gear" },
    { name: "Bomb", emoji: "💣", value: "bomb" },
    { name: "Key", emoji: "🔑", value: "key" },
    { name: "Envelope", emoji: "✉️", value: "envelope" },
    { name: "Package", emoji: "📦", value: "package" },
    { name: "Money Bag", emoji: "💰", value: "money_bag" },
    { name: "Credit Card", emoji: "💳", value: "credit_card" },
    { name: "Chart Increasing", emoji: "📈", value: "chart_increasing" },
    { name: "Paperclip", emoji: "📎", value: "paperclip" },
    { name: "Notebook", emoji: "📓", value: "notebook" },
    { name: "Books", emoji: "📚", value: "books" },
    { name: "Scissors", emoji: "✂️", value: "scissors" },
    { name: "Magnifying Glass", emoji: "🔍", value: "magnifying_glass" }
  ],

  "Symbols": [
    { name: "Red Heart", emoji: "❤️", value: "red_heart" },
    { name: "Orange Heart", emoji: "🧡", value: "orange_heart" },
    { name: "Yellow Heart", emoji: "💛", value: "yellow_heart" },
    { name: "Green Heart", emoji: "💚", value: "green_heart" },
    { name: "Blue Heart", emoji: "💙", value: "blue_heart" },
    { name: "Purple Heart", emoji: "💜", value: "purple_heart" },
    { name: "Black Heart", emoji: "🖤", value: "black_heart" },
    { name: "White Heart", emoji: "🤍", value: "white_heart" },
    { name: "Brown Heart", emoji: "🤎", value: "brown_heart" },
    { name: "Broken Heart", emoji: "💔", value: "broken_heart" },
    { name: "Hundred Points", emoji: "💯", value: "hundred_points" },
    { name: "Collision", emoji: "💥", value: "collision" },
    { name: "Anger Symbol", emoji: "💢", value: "anger_symbol" },
    { name: "Droplet", emoji: "💧", value: "droplet" },
    { name: "Sweat Droplets", emoji: "💦", value: "sweat_droplets" },
    { name: "Check Mark Button", emoji: "✅", value: "check_mark_button" },
    { name: "Cross Mark", emoji: "❌", value: "cross_mark" },
    { name: "Warning", emoji: "⚠️", value: "warning" },
    { name: "Prohibited", emoji: "🚫", value: "prohibited" },
    { name: "Recycling Symbol", emoji: "♻️", value: "recycling" },
    { name: "Right Arrow", emoji: "➡️", value: "arrow_right" },
    { name: "Left Arrow", emoji: "⬅️", value: "arrow_left" },
    { name: "Up Arrow", emoji: "⬆️", value: "arrow_up" },
    { name: "Down Arrow", emoji: "⬇️", value: "arrow_down" },
    { name: "Play Button", emoji: "▶️", value: "play_button" },
    { name: "Pause Button", emoji: "⏸️", value: "pause_button" },
    { name: "Repeat", emoji: "🔁", value: "repeat" },
    { name: "Repeat Single", emoji: "🔂", value: "repeat_single" },
    { name: "Number Sign", emoji: "#️⃣", value: "keycap_number" },
    { name: "Asterisk", emoji: "*️⃣", value: "keycap_asterisk" },
    { name: "Copyright", emoji: "©️", value: "copyright" },
    { name: "Registered", emoji: "®️", value: "registered" },
    { name: "Trade Mark", emoji: "™️", value: "trade_mark" },
    { name: "Om", emoji: "🕉️", value: "om_symbol" },
    { name: "Star of David", emoji: "✡️", value: "star_of_david" },
    { name: "Yin Yang", emoji: "☯️", value: "yin_yang" },
    { name: "Wheel of Dharma", emoji: "☸️", value: "wheel_of_dharma" },
    { name: "Latin Cross", emoji: "✝️", value: "latin_cross" },
    { name: "Star and Crescent", emoji: "☪️", value: "star_crescent" }
  ],

  "Flags": [
    { name: "France", emoji: "🇫🇷", value: "flag_fr" },
    { name: "United States", emoji: "🇺🇸", value: "flag_us" },
    { name: "United Kingdom", emoji: "🇬🇧", value: "flag_gb" },
    { name: "Germany", emoji: "🇩🇪", value: "flag_de" },
    { name: "Italy", emoji: "🇮🇹", value: "flag_it" },
    { name: "Spain", emoji: "🇪🇸", value: "flag_es" },
    { name: "Portugal", emoji: "🇵🇹", value: "flag_pt" },
    { name: "Canada", emoji: "🇨🇦", value: "flag_ca" },
    { name: "Brazil", emoji: "🇧🇷", value: "flag_br" },
    { name: "Mexico", emoji: "🇲🇽", value: "flag_mx" },
    { name: "Japan", emoji: "🇯🇵", value: "flag_jp" },
    { name: "China", emoji: "🇨🇳", value: "flag_cn" },
    { name: "South Korea", emoji: "🇰🇷", value: "flag_kr" },
    { name: "India", emoji: "🇮🇳", value: "flag_in" },
    { name: "Australia", emoji: "🇦🇺", value: "flag_au" },
    { name: "Singapore", emoji: "🇸🇬", value: "flag_sg" },
    { name: "Hong Kong SAR", emoji: "🇭🇰", value: "flag_hk" },
    { name: "United Arab Emirates", emoji: "🇦🇪", value: "flag_ae" },
    { name: "Israel", emoji: "🇮🇱", value: "flag_il" },
    { name: "Turkey", emoji: "🇹🇷", value: "flag_tr" }
  ],
"Weapons & Combat": [
    { name: "Sword", emoji: "⚔️", value: "sword" },
    { name: "Shield", emoji: "🛡️", value: "shield" },
    { name: "Bow & Arrow", emoji: "🏹", value: "bow" },
    { name: "Axe", emoji: "🪓", value: "axe" },
    { name: "Dagger", emoji: "🗡️", value: "dagger" },
    { name: "Crossbow", emoji: "🏹", value: "crossbow" },
    { name: "Hammer", emoji: "🔨", value: "hammer" }
  ],
  "Magic & Mystical": [
    { name: "Crystal Ball", emoji: "🔮", value: "crystal_ball" },
    { name: "Magic Wand", emoji: "🪄", value: "wand" },
    { name: "Spell Book", emoji: "📕", value: "book" },
    { name: "Potion", emoji: "🧪", value: "potion" },
    { name: "Sparkles", emoji: "✨", value: "sparkles" },
    { name: "Staff", emoji: "🧙‍♂️", value: "staff" }
  ],
  "Treasures & Valuables": [
    { name: "Crown", emoji: "👑", value: "crown" },
    { name: "Gem Stone", emoji: "💎", value: "gem" },
    { name: "Coin", emoji: "🪙", value: "coin" },
    { name: "Money Bag", emoji: "💰", value: "money_bag" },
    { name: "Ring", emoji: "💍", value: "ring" },
    { name: "Trophy", emoji: "🏆", value: "trophy" }
  ],
  "Clothing & Accessories": [
    { name: "Armor", emoji: "🥋", value: "armor" },
    { name: "Helmet", emoji: "⛑️", value: "helmet" },
    { name: "Boots", emoji: "👢", value: "boots" },
    { name: "Gloves", emoji: "🧤", value: "gloves" },
    { name: "Pendant", emoji: "📿", value: "pendant" },
    { name: "Smiley", emoji: "😊", value: "smiley" },
    { name: "Amulet", emoji: "🧿", value: "amulet" }
  ],
  "Artifacts & Items": [
    { name: "Scroll", emoji: "📜", value: "scroll" },
    { name: "Treasure Chest", emoji: "🧰", value: "chest" },
    { name: "Key", emoji: "🔑", value: "key" },
    { name: "Hourglass", emoji: "⌛", value: "hourglass" },
    { name: "Compass", emoji: "🧭", value: "compass" },
    { name: "Torch", emoji: "🔦", value: "torch" }
  ],
  "Creatures & Mythical": [
    { name: "Dragon", emoji: "🐉", value: "dragon" },
    { name: "Unicorn", emoji: "🦄", value: "unicorn" },
    { name: "Phoenix", emoji: "🦅", value: "phoenix" },
    { name: "Mermaid", emoji: "🧜‍♀️", value: "mermaid" },
    { name: "Ghost", emoji: "👻", value: "ghost" },
    { name: "Alien", emoji: "👽", value: "alien" }
  ],
  "Nature & Elements": [
    { name: "Fire", emoji: "🔥", value: "fire" },
    { name: "Water", emoji: "💧", value: "water" },
    { name: "Lightning", emoji: "⚡", value: "lightning" },
    { name: "Leaf", emoji: "🍃", value: "leaf" },
    { name: "Skull", emoji: "💀", value: "skull" },
    { name: "Rock", emoji: "🪨", value: "rock" }
  ],
  "Food & Potions": [
    { name: "Apple", emoji: "🍎", value: "apple" },
    { name: "Bread", emoji: "🍞", value: "bread" },
    { name: "Cheese", emoji: "🧀", value: "cheese" },
    { name: "Meat", emoji: "🍖", value: "meat" },
    { name: "Mushroom", emoji: "🍄", value: "mushroom" },
    { name: "Elixir", emoji: "🧴", value: "elixir" }
  ]
};

// Example: export default emojiCategories;

        
        // ==================== Module: Utilities ====================
        const Utilities = AppModules.define('utilities', () => {
            function getEmojiByValue(value) {
                for (const category in emojiCategories) {
                    const emoji = emojiCategories[category].find(e => e.value === value);
                    if (emoji) return emoji.emoji;
                }
                return "❓"; // Default fallback emoji
            }

            function renderEmoji(value, size = 'text-3xl') {
                return `<span class="${size} emoji-icon">${getEmojiByValue(value)}</span>`;
            }

            function formatDate(date) {
                return new Date(date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }

            return {
                getEmojiByValue,
                renderEmoji,
                formatDate
            };
        });

        const { getEmojiByValue, renderEmoji, formatDate } = Utilities;

        // ==================== Module: Notifications ====================
        const Notifications = AppModules.define('notifications', () => {
            function showNotification(message, type = 'success') {
                const id = Date.now().toString();
                const colors = type === 'success'
                    ? 'bg-green-50 dark:bg-green-900 text-green-800 dark:text-green-100'
                    : 'bg-red-50 dark:bg-red-900 text-red-800 dark:text-red-100';

                const iconColors = type === 'success'
                    ? 'text-green-400 dark:text-green-300'
                    : 'text-red-400 dark:text-red-300';

                const icon = type === 'success'
                    ? `<svg class="h-5 w-5 ${iconColors}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`
                    : `<svg class="h-5 w-5 ${iconColors}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`;

                const notification = document.createElement('div');
                notification.id = `notification-${id}`;
                notification.className = `max-w-sm w-full ${colors} shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden transform transition-all duration-300 ease-in-out translate-y-2 opacity-0`;
                notification.innerHTML = `
                    <div class="p-4">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                ${icon}
                            </div>
                            <div class="ml-3 w-0 flex-1 pt-0.5">
                                <p class="text-sm font-medium">${message}</p>
                            </div>
                            <div class="ml-4 flex-shrink-0 flex">
                                <button class="bg-transparent rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                    <span class="sr-only">Close</span>
                                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                const container = document.getElementById('notificationContainer');
                container.appendChild(notification);

                // Animate in
                setTimeout(() => {
                    notification.classList.remove('translate-y-2', 'opacity-0');
                }, 10);

                // Remove after duration
                setTimeout(() => {
                    notification.classList.add('translate-y-2', 'opacity-0');
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 5000);

                // Handle close button
                notification.querySelector('button').addEventListener('click', () => {
                    notification.classList.add('translate-y-2', 'opacity-0');
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                });
            }

            function showConfirmation(title, message, confirmText, callback) {
                const modalTitle = document.getElementById('confirmation-modal-title');
                const modalMessage = document.getElementById('confirmation-modal-message');
                const confirmButton = document.getElementById('confirmActionButton');

                modalTitle.textContent = title;
                modalMessage.textContent = message;
                confirmButton.textContent = confirmText;

                document.getElementById('confirmationModal').classList.remove('hidden');

                const handleConfirm = () => {
                    callback();
                    document.getElementById('confirmationModal').classList.add('hidden');
                    confirmButton.removeEventListener('click', handleConfirm);
                };

                confirmButton.addEventListener('click', handleConfirm);

                document.getElementById('cancelActionButton').addEventListener('click', function() {
                    document.getElementById('confirmationModal').classList.add('hidden');
                    confirmButton.removeEventListener('click', handleConfirm);
                }, { once: true });
            }

            return {
                showNotification,
                showConfirmation
            };
        });

        const { showNotification, showConfirmation } = Notifications;

        // ==================== Module: Engagement Systems ====================
        const Engagement = AppModules.define('engagement', () => {
            const QUEST_STORAGE_PREFIX = 'collectibleRealm::quests::';
            const rarityOrder = {
                common: 1,
                uncommon: 2,
                rare: 3,
                epic: 4,
                legendary: 5,
                mythic: 6
            };

            function dateKey(value = new Date()) {
                const date = new Date(value);
                date.setHours(0, 0, 0, 0);
                return date.toISOString().split('T')[0];
            }

            function xpThreshold(level) {
                return 200 + (level - 1) * 140;
            }

            function computeStreakStats(activities = []) {
                if (!activities || activities.length === 0) {
                    return { streak: 0, longestStreak: 0, lastActive: null, bonusXp: 0 };
                }

                const uniqueDays = Array.from(new Set(
                    activities
                        .map(activity => activity?.created_at ? dateKey(activity.created_at) : null)
                        .filter(Boolean)
                )).sort();

                if (uniqueDays.length === 0) {
                    return { streak: 0, longestStreak: 0, lastActive: null, bonusXp: 0 };
                }

                const datesAsc = uniqueDays.map(value => {
                    const date = new Date(value);
                    date.setHours(0, 0, 0, 0);
                    return date;
                });

                const datesDesc = [...datesAsc].sort((a, b) => b - a);

                let currentStreak = 1;
                for (let i = 1; i < datesDesc.length; i++) {
                    const diff = Math.round((datesDesc[i - 1] - datesDesc[i]) / 86400000);
                    if (diff === 1) {
                        currentStreak += 1;
                    } else {
                        break;
                    }
                }

                const latest = datesDesc[0];
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const diffToToday = Math.round((today - latest) / 86400000);
                if (diffToToday > 1) {
                    currentStreak = 0;
                }

                let longestStreak = 1;
                let running = 1;
                for (let i = 1; i < datesAsc.length; i++) {
                    const diff = Math.round((datesAsc[i] - datesAsc[i - 1]) / 86400000);
                    if (diff === 1) {
                        running += 1;
                        longestStreak = Math.max(longestStreak, running);
                    } else {
                        running = 1;
                    }
                }

                const bonusXp = currentStreak * 15;

                return {
                    streak: currentStreak,
                    longestStreak,
                    lastActive: latest,
                    bonusXp
                };
            }

            function calculateProgression() {
                const collectibles = appState.collectibles || [];
                const activities = appState.activities || [];
                const streakStats = computeStreakStats(activities);

                const rarityWeights = {
                    common: 25,
                    uncommon: 35,
                    rare: 55,
                    epic: 80,
                    legendary: 120,
                    mythic: 160
                };

                const collectibleXp = collectibles.reduce((sum, item) => sum + (rarityWeights[item.rarity] || 25), 0);
                const activityXp = Math.min(activities.length * 12, 360);
                const totalXp = Math.round(collectibleXp + activityXp + streakStats.bonusXp);

                let level = 1;
                let xpForNextLevel = xpThreshold(level);
                let xpRemaining = totalXp;

                while (xpRemaining >= xpForNextLevel) {
                    xpRemaining -= xpForNextLevel;
                    level += 1;
                    xpForNextLevel = xpThreshold(level);
                }

                const progressPercent = xpForNextLevel
                    ? Math.min(100, Math.round((xpRemaining / xpForNextLevel) * 100))
                    : 0;

                const rareCount = collectibles.filter(item => rarityOrder[item.rarity] >= rarityOrder.rare).length;

                return {
                    xp: totalXp,
                    level,
                    xpIntoLevel: xpRemaining,
                    xpForNextLevel,
                    progressPercent,
                    streak: streakStats.streak,
                    longestStreak: streakStats.longestStreak,
                    lastActiveDate: streakStats.lastActive,
                    bonusXp: streakStats.bonusXp,
                    rareCount,
                    totalCollectibles: collectibles.length
                };
            }

            function getQuestPool() {
                return [
                    {
                        id: 'redeem_two',
                        title: 'Redeem Two Codes',
                        description: 'Redeem two different codes today.',
                        type: 'redeem',
                        target: 2,
                        rewardXp: 120,
                        icon: '🗝️'
                    },
                    {
                        id: 'collection_growth',
                        title: 'Expand Your Vault',
                        description: 'Reach a collection size of 15 items.',
                        type: 'collectionSize',
                        target: 15,
                        rewardXp: 140,
                        icon: '📦'
                    },
                    {
                        id: 'rare_hunter',
                        title: 'Rare Hunter',
                        description: 'Own at least one rare or better collectible.',
                        type: 'rarity',
                        rarity: 'rare',
                        target: 1,
                        rewardXp: 160,
                        icon: '💠'
                    },
                    {
                        id: 'legendary_track',
                        title: 'Legendary Aspirations',
                        description: 'Secure a legendary or mythic collectible.',
                        type: 'rarity',
                        rarity: 'legendary',
                        target: 1,
                        rewardXp: 220,
                        icon: '🌟'
                    },
                    {
                        id: 'activity_stream',
                        title: 'Keep the Feed Alive',
                        description: 'Log three activities today.',
                        type: 'activityCount',
                        target: 3,
                        rewardXp: 90,
                        icon: '📣'
                    },
                    {
                        id: 'streak_keeper',
                        title: 'Maintain the Flame',
                        description: 'Hold a streak of three days or more.',
                        type: 'streak',
                        target: 3,
                        rewardXp: 150,
                        icon: '🔥'
                    },
                    {
                        id: 'welcome_back',
                        title: 'Realm Check-In',
                        description: 'Log in today to refresh your journey.',
                        type: 'login',
                        target: 1,
                        rewardXp: 60,
                        icon: '👋'
                    },
                    {
                        id: 'epic_collection',
                        title: 'Epic Ensemble',
                        description: 'Collect three epic or better artifacts.',
                        type: 'rarity',
                        rarity: 'epic',
                        target: 3,
                        rewardXp: 180,
                        icon: '🛡️'
                    }
                ];
            }

            function seedFromString(input) {
                let hash = 0;
                for (let i = 0; i < input.length; i++) {
                    hash = ((hash << 5) - hash) + input.charCodeAt(i);
                    hash |= 0;
                }
                return Math.abs(hash);
            }

            function loadQuestCache(userId) {
                if (typeof localStorage === 'undefined') return null;
                try {
                    const raw = localStorage.getItem(`${QUEST_STORAGE_PREFIX}${userId}`);
                    return raw ? JSON.parse(raw) : null;
                } catch (error) {
                    console.warn('Unable to load quest cache', error);
                    return null;
                }
            }

            function saveQuestCache(userId, payload) {
                if (typeof localStorage === 'undefined') return;
                try {
                    localStorage.setItem(`${QUEST_STORAGE_PREFIX}${userId}`, JSON.stringify(payload));
                } catch (error) {
                    console.warn('Unable to persist quest cache', error);
                }
            }

            function selectQuestsForToday(userId, { reroll = false } = {}) {
                if (!userId) return [];
                const today = dateKey();
                let cache = reroll ? null : loadQuestCache(userId);

                if (!cache || cache.date !== today) {
                    const pool = getQuestPool();
                    const selected = [];
                    let seed = seedFromString(`${userId}-${today}`);

                    while (selected.length < Math.min(3, pool.length)) {
                        seed = (seed * 9301 + 49297) % 233280;
                        const index = seed % pool.length;
                        const candidate = pool[index];
                        if (!selected.some(item => item.id === candidate.id)) {
                            selected.push(candidate);
                        }
                    }

                    cache = { date: today, quests: selected.map(q => q.id) };
                    saveQuestCache(userId, cache);
                }

                const poolMap = new Map(getQuestPool().map(item => [item.id, item]));
                return (cache.quests || [])
                    .map(id => poolMap.get(id))
                    .filter(Boolean);
            }

            function evaluateQuest(definition, progression) {
                if (!definition) return null;

                const today = dateKey();
                let progress = 0;

                switch (definition.type) {
                    case 'redeem':
                        progress = appState.activities.filter(activity =>
                            activity.action === 'redeemed' &&
                            activity.created_at &&
                            dateKey(activity.created_at) === today
                        ).length;
                        break;
                    case 'activityCount':
                        progress = appState.activities.filter(activity =>
                            activity.created_at &&
                            dateKey(activity.created_at) === today
                        ).length;
                        break;
                    case 'collectionSize':
                        progress = appState.collectibles.length;
                        break;
                    case 'rarity':
                        progress = appState.collectibles.filter(item =>
                            rarityOrder[item.rarity] >= rarityOrder[definition.rarity]
                        ).length;
                        break;
                    case 'streak':
                        progress = progression?.streak ?? 0;
                        break;
                    case 'login':
                        progress = appState.currentUser ? 1 : 0;
                        break;
                    default:
                        progress = 0;
                }

                const clamped = Math.min(progress, definition.target);
                const percent = definition.target
                    ? Math.min(100, Math.round((clamped / definition.target) * 100))
                    : 0;

                return {
                    ...definition,
                    progress: clamped,
                    completed: progress >= definition.target,
                    progressPercent: percent
                };
            }

            function evaluateAchievements(progression) {
                const definitions = [
                    {
                        id: 'first_relic',
                        title: 'First Relic',
                        description: 'Redeem your first collectible.',
                        target: 1,
                        icon: '🔓',
                        progress: () => appState.collectibles.length
                    },
                    {
                        id: 'vault_keeper',
                        title: 'Vault Keeper',
                        description: 'Own 10 collectibles.',
                        target: 10,
                        icon: '🏰',
                        progress: () => appState.collectibles.length
                    },
                    {
                        id: 'legendary_finder',
                        title: 'Legendary Finder',
                        description: 'Secure a legendary or mythic collectible.',
                        target: 1,
                        icon: '🌠',
                        progress: () => appState.collectibles.filter(item => rarityOrder[item.rarity] >= rarityOrder.legendary).length
                    },
                    {
                        id: 'streak_master',
                        title: 'Streak Guardian',
                        description: 'Maintain a 5-day streak of activity.',
                        target: 5,
                        icon: '🔥',
                        progress: () => progression?.longestStreak ?? 0
                    },
                    {
                        id: 'diversity_collector',
                        title: 'Curator of Realms',
                        description: 'Collect items from four different rarity tiers.',
                        target: 4,
                        icon: '🧭',
                        progress: () => new Set(appState.collectibles.map(item => item.rarity)).size
                    }
                ];

                return definitions.map(def => {
                    const progressValue = def.progress();
                    const clamped = Math.min(progressValue, def.target);
                    const percent = def.target
                        ? Math.min(100, Math.round((clamped / def.target) * 100))
                        : 0;

                    return {
                        id: def.id,
                        name: def.title,
                        description: def.description,
                        target: def.target,
                        progress: clamped,
                        progressPercent: percent,
                        completed: progressValue >= def.target,
                        icon: def.icon
                    };
                });
            }

            function deriveInsights() {
                const counts = {
                    common: 0,
                    uncommon: 0,
                    rare: 0,
                    epic: 0,
                    legendary: 0,
                    mythic: 0
                };

                const motifTally = new Map();

                appState.collectibles.forEach(item => {
                    if (counts[item.rarity] !== undefined) {
                        counts[item.rarity] += 1;
                    }
                    if (item.item_graphic) {
                        motifTally.set(item.item_graphic, (motifTally.get(item.item_graphic) || 0) + 1);
                    }
                });

                const rarityEntries = Object.entries(counts)
                    .filter(([, count]) => count > 0)
                    .sort((a, b) => {
                        if (rarityOrder[b[0]] === rarityOrder[a[0]]) {
                            return counts[b[0]] - counts[a[0]];
                        }
                        return rarityOrder[b[0]] - rarityOrder[a[0]];
                    });

                const favouriteMotif = Array.from(motifTally.entries())
                    .sort((a, b) => b[1] - a[1])[0] || null;

                return {
                    counts,
                    total: appState.collectibles.length,
                    uniqueRarities: rarityEntries.length,
                    topRarity: rarityEntries[0]?.[0] || null,
                    topRarityCount: rarityEntries[0]?.[1] || 0,
                    favouriteEmoji: favouriteMotif ? getEmojiByValue(favouriteMotif[0]) : null,
                    favouriteEmojiKey: favouriteMotif ? favouriteMotif[0] : null
                };
            }

            function buildSeasonEvents(progression, insights) {
                const events = [];
                const resetDate = new Date();
                resetDate.setHours(24, 0, 0, 0);

                const rarest = [...(appState.collectibles || [])]
                    .sort((a, b) => {
                        const rarityDiff = (rarityOrder[b.rarity] || 0) - (rarityOrder[a.rarity] || 0);
                        if (rarityDiff !== 0) return rarityDiff;
                        return new Date(b.acquired_date || 0) - new Date(a.acquired_date || 0);
                    })[0];

                if (rarest) {
                    events.push({
                        id: 'rarest-spotlight',
                        title: `Spotlight: ${rarest.item_name}`,
                        description: `Your ${rarest.rarity} discovery is shining bright. Relive the moment from ${formatDate(rarest.acquired_date || new Date())}.`,
                        tag: 'Spotlight',
                        icon: getEmojiByValue(rarest.item_graphic)
                    });
                }

                events.push({
                    id: 'season-reset',
                    title: 'Aurora Season Countdown',
                    description: progression
                        ? `Earn ${Math.max(progression.xpForNextLevel - progression.xpIntoLevel, 0)} XP to reach level ${progression.level + 1} before the daily reset.`
                        : 'Level up before the next reset to unlock seasonal rewards.',
                    tag: 'Season Quest',
                    icon: '⏳',
                    resetDate
                });

                if (insights?.favouriteEmoji) {
                    const label = insights.favouriteEmojiKey
                        ? insights.favouriteEmojiKey.split('_').join(' ')
                        : 'favourite motif';
                    events.push({
                        id: 'motif-highlight',
                        title: 'Motif of the Day',
                        description: `You've collected ${insights.favouriteEmoji} ${label} more than any other. Share it in the community!`,
                        tag: 'Community',
                        icon: insights.favouriteEmoji
                    });
                }

                return events;
            }

            function sync(options = {}) {
                if (!appState.currentUser) {
                    stateStore.setState({
                        progression: null,
                        quests: [],
                        achievements: [],
                        seasonEvents: [],
                        journeyInsights: null
                    }, 'engagement:reset');
                    return {
                        progression: null,
                        quests: [],
                        achievements: [],
                        seasonEvents: [],
                        insights: null
                    };
                }

                const progression = calculateProgression();
                const insights = deriveInsights();
                const questDefinitions = selectQuestsForToday(appState.currentUser.id, { reroll: options.rerollQuests });
                const quests = questDefinitions
                    .map(def => evaluateQuest(def, progression))
                    .filter(Boolean);
                const achievements = evaluateAchievements(progression);
                const seasonEvents = buildSeasonEvents(progression, insights);

                stateStore.setState({
                    progression,
                    quests,
                    achievements,
                    seasonEvents,
                    journeyInsights: insights
                }, 'engagement:sync');

                return { progression, quests, achievements, seasonEvents, insights };
            }

            function favouriteLabel(insights) {
                if (!insights?.favouriteEmoji) return 'Redeem more to reveal trends.';
                const label = insights.favouriteEmojiKey
                    ? insights.favouriteEmojiKey.split('_').join(' ')
                    : 'favourite motif';
                return `Favoured motif ${insights.favouriteEmoji} ${label}`.trim();
            }

            function renderProgressionOverview() {
                const container = document.getElementById('progressionOverviewCard');
                const summary = document.getElementById('progressionSummary');

                if (!container) return;

                if (!appState.currentUser) {
                    container.innerHTML = `<div class="text-sm text-gray-500 dark:text-gray-400">Sign in to begin tracking your progress.</div>`;
                    if (summary) summary.classList.add('hidden');
                    return;
                }

                const data = appState.progression;
                if (!data) {
                    container.innerHTML = `<div class="text-sm text-gray-500 dark:text-gray-400">Redeem a code to unlock your progression journey.</div>`;
                    if (summary) summary.classList.add('hidden');
                    return;
                }

                const insights = appState.journeyInsights;
                const xpRemaining = Math.max(data.xpForNextLevel - data.xpIntoLevel, 0);
                const lastActive = data.lastActiveDate ? formatDate(data.lastActiveDate) : 'No activity yet';

                if (summary) {
                    summary.textContent = `Level ${data.level} • ${data.xp} XP earned`;
                    summary.classList.remove('hidden');
                }

                container.innerHTML = `
                    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-6">
                        <div>
                            <p class="text-xs font-semibold text-primary-500 uppercase tracking-wide">Level ${data.level}</p>
                            <h3 class="mt-2 text-2xl font-bold text-gray-900 dark:text-white">${appState.userProfile?.username || 'Explorer'}</h3>
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Only ${xpRemaining} XP to reach level ${data.level + 1}.</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="relative">
                                <div class="h-16 w-16 rounded-full bg-gradient-to-br from-primary-500 to-primary-400 flex items-center justify-center text-white text-2xl font-bold shadow-lg">${data.level}</div>
                                <span class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Rank</span>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Current Streak</p>
                                <p class="text-xl font-semibold text-gray-900 dark:text-white">${data.streak} days</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Longest streak: ${data.longestStreak} days</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-3 rounded-full bg-gradient-to-r from-primary-500 to-primary-400" style="width: ${data.progressPercent}%;"></div>
                        </div>
                        <div class="mt-2 flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                            <span>${data.xpIntoLevel} / ${data.xpForNextLevel} XP this level</span>
                            <span>${data.progressPercent}%</span>
                        </div>
                    </div>
                    <dl class="mt-6 grid grid-cols-1 gap-4 sm:grid-cols-3">
                        <div class="p-4 rounded-lg bg-primary-50 dark:bg-primary-900/40 border border-primary-100 dark:border-primary-800/60">
                            <dt class="text-xs font-semibold text-primary-600 dark:text-primary-300 uppercase tracking-wide">Rarest Tier</dt>
                            <dd class="mt-2 text-lg font-semibold text-gray-900 dark:text-white">${insights?.topRarity ? insights.topRarity.charAt(0).toUpperCase() + insights.topRarity.slice(1) : 'None yet'}</dd>
                            <dd class="text-xs text-gray-500 dark:text-gray-400">${insights?.topRarityCount ? `${insights.topRarityCount} discovered` : 'Redeem a code to discover one.'}</dd>
                        </div>
                        <div class="p-4 rounded-lg bg-white dark:bg-gray-900/40 border border-gray-100 dark:border-gray-700/60">
                            <dt class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Last Active</dt>
                            <dd class="mt-2 text-lg font-semibold text-gray-900 dark:text-white">${lastActive}</dd>
                            <dd class="text-xs text-gray-500 dark:text-gray-400">Bonus XP: +${data.bonusXp}</dd>
                        </div>
                        <div class="p-4 rounded-lg bg-white dark:bg-gray-900/40 border border-gray-100 dark:border-gray-700/60">
                            <dt class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Collection Insights</dt>
                            <dd class="mt-2 text-lg font-semibold text-gray-900 dark:text-white">${insights?.total || 0} items</dd>
                            <dd class="text-xs text-gray-500 dark:text-gray-400">${favouriteLabel(insights)}</dd>
                        </div>
                    </dl>
                `;
            }

            function getQuestCountdown() {
                const now = new Date();
                const reset = new Date();
                reset.setHours(24, 0, 0, 0);
                const diff = reset - now;

                if (diff <= 0) {
                    return '0h 00m';
                }

                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);

                return `${hours}h ${minutes.toString().padStart(2, '0')}m`;
            }

            function renderQuestBoard() {
                const container = document.getElementById('questBoard');
                const countdown = document.getElementById('questResetCountdown');

                if (!container) return;

                if (countdown) {
                    countdown.textContent = `Resets in ${getQuestCountdown()}`;
                }

                if (!appState.currentUser) {
                    container.innerHTML = `<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-sm text-gray-500 dark:text-gray-400">Sign in to receive your personalised quest board.</div>`;
                    return;
                }

                const quests = appState.quests || [];
                if (!quests.length) {
                    container.innerHTML = `<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-sm text-gray-500 dark:text-gray-400">No quests available yet. Redeem codes to unlock new objectives.</div>`;
                    return;
                }

                container.innerHTML = '';

                quests.forEach(quest => {
                    const percent = quest.progressPercent ?? (quest.target ? Math.min(100, Math.round((quest.progress / quest.target) * 100)) : 0);
                    const statusColor = quest.completed
                        ? 'text-green-600 dark:text-green-300'
                        : 'text-gray-500 dark:text-gray-400';

                    const card = document.createElement('article');
                    card.className = 'bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-100 dark:border-gray-700/60 transition-transform transform hover:-translate-y-1 hover:shadow-lg';

                    card.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="text-xs uppercase tracking-wide text-gray-400 dark:text-gray-500">${quest.icon || '🎯'} Quest</p>
                                <h3 class="mt-1 text-lg font-semibold text-gray-900 dark:text-white">${quest.title}</h3>
                                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">${quest.description}</p>
                            </div>
                            <span class="ml-4 inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-primary-100 dark:bg-primary-900/50 text-primary-700 dark:text-primary-200">${quest.rewardXp} XP</span>
                        </div>
                        <div class="mt-4">
                            <div class="h-2.5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-2.5 rounded-full ${quest.completed ? 'bg-green-500' : 'bg-gradient-to-r from-primary-500 to-primary-400'}" style="width: ${quest.completed ? 100 : percent}%;"></div>
                            </div>
                            <div class="mt-2 flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                                <span>${quest.progress}/${quest.target}</span>
                                <span class="${statusColor}">${quest.completed ? 'Reward Ready' : 'In Progress'}</span>
                            </div>
                        </div>
                        ${quest.completed
                            ? `<button data-quest-claim="${quest.id}" class="mt-4 w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-gray-900">Claim Reward</button>`
                            : `<button class="mt-4 w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-700 text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800" disabled>Keep going</button>`}
                    `;

                    container.appendChild(card);
                });

                container.querySelectorAll('[data-quest-claim]').forEach(button => {
                    button.addEventListener('click', () => {
                        showNotification('Quest reward tracked! XP bonuses will sync once backend rewards are enabled.');
                    });
                });
            }

            function renderAchievementShowcase() {
                const container = document.getElementById('achievementShowcase');

                if (!container) return;

                if (!appState.currentUser) {
                    container.innerHTML = `<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-sm text-gray-500 dark:text-gray-400">Sign in to start unlocking achievements.</div>`;
                    return;
                }

                const achievements = (appState.achievements || [])
                    .slice()
                    .sort((a, b) => {
                        if (a.completed === b.completed) {
                            return (b.progressPercent || 0) - (a.progressPercent || 0);
                        }
                        return a.completed ? -1 : 1;
                    })
                    .slice(0, 4);

                if (!achievements.length) {
                    container.innerHTML = `<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-sm text-gray-500 dark:text-gray-400">Earn achievements by redeeming codes, keeping streaks, and diversifying your collection.</div>`;
                    return;
                }

                container.innerHTML = '';

                achievements.forEach(achievement => {
                    const percent = achievement.progressPercent ?? 0;
                    const badgeClasses = achievement.completed
                        ? 'bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-200'
                        : 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-200';

                    const article = document.createElement('article');
                    article.className = 'relative overflow-hidden rounded-lg border border-gray-100 dark:border-gray-700/60 bg-white dark:bg-gray-800 p-6 shadow transition-transform transform hover:-translate-y-1 hover:shadow-lg';

                    article.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <span class="text-3xl">${achievement.icon || '🏆'}</span>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">${achievement.name}</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">${achievement.description}</p>
                                </div>
                            </div>
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${badgeClasses}">${achievement.completed ? 'Unlocked' : `${percent}%`}</span>
                        </div>
                        <div class="mt-4">
                            <div class="h-2.5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-2.5 rounded-full ${achievement.completed ? 'bg-green-500' : 'bg-primary-400'}" style="width: ${achievement.completed ? 100 : percent}%;"></div>
                            </div>
                            <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">${achievement.progress}/${achievement.target} completed</p>
                        </div>
                    `;

                    container.appendChild(article);
                });
            }

            function renderSeasonShowcase() {
                const container = document.getElementById('seasonShowcase');

                if (!container) return;

                const events = appState.seasonEvents || [];

                if (!events.length) {
                    container.innerHTML = `<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-sm text-gray-500 dark:text-gray-400">No seasonal highlights right now. Check back soon for live events.</div>`;
                    return;
                }

                container.innerHTML = '';

                events.forEach(event => {
                    const article = document.createElement('article');
                    article.className = 'relative overflow-hidden rounded-lg border border-gray-100 dark:border-gray-700/60 bg-white dark:bg-gray-800 p-6 shadow transition-transform transform hover:-translate-y-1 hover:shadow-lg';

                    const resetLabel = event.resetDate ? `Ends ${formatDate(event.resetDate)}` : '';

                    article.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs uppercase tracking-wide ${event.tag ? 'text-primary-500 dark:text-primary-300' : 'text-gray-400 dark:text-gray-500'}">${event.tag || 'Event'}</p>
                                <h3 class="mt-1 text-lg font-semibold text-gray-900 dark:text-white">${event.title}</h3>
                            </div>
                            ${event.icon ? `<span class="text-3xl">${event.icon}</span>` : ''}
                        </div>
                        <p class="mt-3 text-sm text-gray-500 dark:text-gray-400">${event.description}</p>
                        ${resetLabel ? `<p class="mt-3 text-xs text-gray-400 dark:text-gray-500">${resetLabel}</p>` : ''}
                    `;

                    container.appendChild(article);
                });
            }

            function renderAll() {
                renderProgressionOverview();
                renderQuestBoard();
                renderAchievementShowcase();
                renderSeasonShowcase();
            }

            return {
                sync,
                renderAll,
                renderProgressionOverview,
                renderQuestBoard,
                renderAchievementShowcase,
                renderSeasonShowcase
            };
        });

        // Supabase API functions
        async function createUserProfile(user, username) {
            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .insert([
                        { id: user.id, username: username }
                    ]);
                
                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error creating user profile:', error.message);
                throw error;
            }
        }

        async function getUserProfile(userId) {
            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error getting user profile:', error.message);
                throw error;
            }
        }

        async function updateUserProfile(userId, updates) {
            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .update(updates)
                    .eq('id', userId);
                
                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error updating user profile:', error.message);
                throw error;
            }
        }

        async function getAllUsers() {
            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Error getting users:', error.message);
                return [];
            }
        }

        async function loadCodes() {
            try {
                const { data, error } = await supabase
                    .from('redemption_codes')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Error loading codes:', error.message);
                return [];
            }
        }

        async function createCode(codeData) {
            try {
                const { data, error } = await supabase
                    .from('redemption_codes')
                    .insert([{
                        ...codeData,
                        created_by: appState.currentUser.id
                    }]);
                
                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error creating code:', error.message);
                throw error;
            }
        }

        async function updateCode(codeId, updates) {
            try {
                const { data, error } = await supabase
                    .from('redemption_codes')
                    .update(updates)
                    .eq('id', codeId);
                
                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error updating code:', error.message);
                throw error;
            }
        }

        async function deleteCode(codeId) {
            try {
                const { data, error } = await supabase
                    .from('redemption_codes')
                    .delete()
                    .eq('id', codeId);
                
                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error deleting code:', error.message);
                throw error;
            }
        }

        async function loadUserCollectibles(userId) {
            try {
                const { data, error } = await supabase
                    .from('collectibles')
                    .select('*')
                    .eq('user_id', userId)
                    .order('acquired_date', { ascending: false });
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Error loading collectibles:', error.message);
                return [];
            }
        }

        async function createCollectible(collectibleData) {
            try {
                const { data, error } = await supabase
                    .from('collectibles')
                    .insert([collectibleData]);
                
                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error creating collectible:', error.message);
                throw error;
            }
        }

        async function loadUserActivities(userId) {
            try {
                const { data, error } = await supabase
                    .from('activities')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Error loading activities:', error.message);
                return [];
            }
        }

        async function createActivity(activityData) {
            try {
                const { data, error } = await supabase
                    .from('activities')
                    .insert([activityData]);
                
                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error creating activity:', error.message);
                throw error;
            }
        }

        async function loadUserRedemptionHistory(userId) {
            try {
                const { data, error } = await supabase
                    .from('redemption_history')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Error loading redemption history:', error.message);
                return [];
            }
        }

        async function createRedemptionHistory(redemptionData) {
            try {
                const { data, error } = await supabase
                    .from('redemption_history')
                    .insert([redemptionData]);
                
                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error creating redemption history:', error.message);
                throw error;
            }
        }

        // UI Rendering Functions
        function renderUserCollectionStats() {
            if (!appState.currentUser) return;
            
            const collectibles = appState.collectibles;
            const statsContainer = document.getElementById('collectionStats');
            const statsRows = statsContainer.querySelectorAll('div.bg-white');
            
            const rarities = ['common', 'uncommon', 'rare', 'epic', 'legendary', 'mythic'];
            const counts = {};
            
            rarities.forEach(rarity => {
                counts[rarity] = collectibles.filter(c => c.rarity === rarity).length;
            });
            
            rarities.forEach((rarity, index) => {
                if (statsRows[index]) {
                    statsRows[index].querySelector('div.text-lg').textContent = counts[rarity];
                }
            });
        }

        function renderCollection(filter = 'all') {
            if (!appState.currentUser) return;
            
            const collectibles = appState.collectibles;
            const filteredCollectibles = filter === 'all' ? collectibles : collectibles.filter(c => c.rarity === filter);
            const collectionGrid = document.getElementById('collectionGrid');
            
            if (filteredCollectibles.length === 0) {
                if (filter === 'all') {
                    collectionGrid.innerHTML = `
                        <div class="col-span-full text-center p-8 text-gray-500 dark:text-gray-400 italic">
                            Your collection is empty. Redeem a code to get started!
                        </div>
                    `;
                } else {
                    collectionGrid.innerHTML = `
                        <div class="col-span-full text-center p-8 text-gray-500 dark:text-gray-400 italic">
                            You don't have any ${filter} items in your collection.
                        </div>
                    `;
                }
                return;
            }
            
            collectionGrid.innerHTML = '';
            
            filteredCollectibles.forEach(item => {
                // Create glitter elements for legendary and mythic items
                let glitterHtml = '';
                if (item.rarity === 'legendary' || item.rarity === 'mythic') {
                    // Add several glitter dots
                    for (let i = 0; i < 5; i++) {
                        const top = Math.floor(Math.random() * 80) + 10;
                        const left = Math.floor(Math.random() * 80) + 10;
                        const delay = Math.random() * 2;
                        glitterHtml += `<div class="collectible-glitter" style="top: ${top}%; left: ${left}%; animation-delay: ${delay}s"></div>`;
                    }
                }
                
                const div = document.createElement('div');
                div.className = 'collectible-card relative bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow-lg transition-transform transform hover:scale-105 cursor-pointer';
                div.setAttribute('data-item-id', item.id);
                
                div.innerHTML = `
                    <div class="absolute inset-0 rarity-${item.rarity}"></div>
                    <div class="card-shine"></div>
                    <div class="card-border"></div>
                    ${glitterHtml}
                    <div class="relative p-4 flex flex-col items-center">
                        <div class="w-24 h-24 bg-white dark:bg-gray-700 rounded-full flex items-center justify-center mb-4 shadow-lg">
                            <div class="collectible-icon text-center text-4xl">
                                ${getEmojiByValue(item.item_graphic)}
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-1">${item.item_name}</h3>
                        <div class="mb-3">
                            <span class="badge-${item.rarity} rarity-badge">${item.rarity}</span>
                        </div>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-2">Acquired: ${formatDate(item.acquired_date)}</p>
                    </div>
                `;
                
                collectionGrid.appendChild(div);
                
                div.addEventListener('click', () => {
                    showCollectibleDetail(item);
                });
            });
        }

        function showCollectibleDetail(item) {
            const detailContent = document.getElementById('collectibleDetailContent');
            
            // Create glitter elements for legendary and mythic items
            let glitterHtml = '';
            if (item.rarity === 'legendary' || item.rarity === 'mythic') {
                // Add several glitter dots
                for (let i = 0; i < 8; i++) {
                    const top = Math.floor(Math.random() * 80) + 10;
                    const left = Math.floor(Math.random() * 80) + 10;
                    const delay = Math.random() * 2;
                    glitterHtml += `<div class="collectible-glitter" style="top: ${top}%; left: ${left}%; animation-delay: ${delay}s"></div>`;
                }
            }
            
            detailContent.innerHTML = `
                <div class="w-full max-w-xs mx-auto">
                    <div class="collectible-card relative bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow-lg">
                        <div class="absolute inset-0 rarity-${item.rarity}"></div>
                        <div class="card-shine"></div>
                        <div class="card-border"></div>
                        ${glitterHtml}
                        <div class="relative p-6 flex flex-col items-center">
                            <div class="w-32 h-32 bg-white dark:bg-gray-700 rounded-full flex items-center justify-center mb-6 shadow-lg">
                                <div class="collectible-icon text-center text-5xl">
                                    ${getEmojiByValue(item.item_graphic)}
                                </div>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">${item.item_name}</h2>
                            <div class="mb-4">
                                <span class="badge-${item.rarity} rarity-badge px-3 py-1">${item.rarity}</span>
                            </div>
                            <div class="w-full mt-4">
                                <div class="flex justify-between py-2 border-b border-gray-200 dark:border-gray-700">
                                    <span class="text-gray-500 dark:text-gray-400">Acquired</span>
                                    <span class="text-gray-900 dark:text-white">${formatDate(item.acquired_date)}</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-200 dark:border-gray-700">
                                    <span class="text-gray-500 dark:text-gray-400">Type</span>
                                    <span class="text-gray-900 dark:text-white capitalize">${item.item_graphic.replace('_', ' ')}</span>
                                </div>
                                <div class="flex justify-between py-2">
                                    <span class="text-gray-500 dark:text-gray-400">Collection ID</span>
                                    <span class="text-gray-900 dark:text-white">#${item.id.substring(item.id.length - 6).toUpperCase()}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('collectibleDetailModal').classList.remove('hidden');
        }

        async function updateDashboardStats() {
            if (!appState.currentUser) return;

            const collectibles = appState.collectibles;
            document.getElementById('totalCollectibles').textContent = collectibles.length;
            document.getElementById('redeemedCollectibles').textContent = collectibles.length;

            await Economy.sync({ reason: 'dashboard' });
            const wallet = appState.wallet || {};
            const goldNode = document.getElementById('realmGoldBalance');
            const gemNode = document.getElementById('stellarGemBalance');
            if (goldNode) {
                goldNode.textContent = formatNumber(wallet.gold || 0);
            }
            if (gemNode) {
                gemNode.textContent = formatNumber(wallet.gems || 0);
            }

            // Find rarest collectible
            const rarityOrder = {
                'common': 1,
                'uncommon': 2,
                'rare': 3,
                'epic': 4,
                'legendary': 5,
                'mythic': 6
            };
            
            let rarestCollectible = null;
            let highestRarity = 0;
            
            collectibles.forEach(item => {
                if (rarityOrder[item.rarity] > highestRarity) {
                    highestRarity = rarityOrder[item.rarity];
                    rarestCollectible = item;
                }
            });
            
            if (rarestCollectible) {
                document.getElementById('rarestCollectible').textContent = `${rarestCollectible.item_name} (${rarestCollectible.rarity})`;
            } else {
                document.getElementById('rarestCollectible').textContent = 'None';
            }
        }

        function renderActivityFeed() {
            if (!appState.currentUser) return;
            
            const userActivities = appState.activities;
            const activityFeed = document.getElementById('activityFeed');
            
            if (userActivities.length === 0) {
                activityFeed.innerHTML = `
                    <li class="px-4 py-4 flex text-gray-500 dark:text-gray-400 italic">No recent activity to display</li>
                `;
                return;
            }
            
            activityFeed.innerHTML = '';
            
            // Take only the 5 most recent
            const recentActivities = userActivities.slice(0, 5);
            
            recentActivities.forEach(activity => {
                const li = document.createElement('li');
                li.className = 'px-4 py-3 sm:px-6 transition-colors duration-150 hover:bg-gray-50 dark:hover:bg-gray-700';
                
                li.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="h-10 w-10 rounded-full bg-primary-100 dark:bg-primary-900 flex items-center justify-center shadow-sm">
                                    <svg class="h-6 w-6 text-primary-600 dark:text-primary-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-700 dark:text-gray-300">
                                    You ${activity.action} a <span class="badge-${activity.item_rarity} rarity-badge">${activity.item_rarity}</span> item: <span class="font-medium text-gray-900 dark:text-white">${activity.item_name}</span>
                                </p>
                            </div>
                        </div>
                        <div class="ml-4 flex-shrink-0">
                            <span class="text-sm text-gray-500 dark:text-gray-400">${formatDate(activity.created_at)}</span>
                        </div>
                    </div>
                `;
                
                activityFeed.appendChild(li);
            });
        }

        function renderFeaturedCollectibles() {
            const featuredContainer = document.getElementById('featuredCollectibles');

            if (!appState.isAdmin) {
                featuredContainer.innerHTML = `
                    <div class="col-span-full flex flex-col sm:flex-row gap-6 justify-center">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden transition-all duration-300 hover:shadow-xl transform hover:scale-105">
                            <div class="p-6 flex flex-col items-center text-center">
                                <div class="w-20 h-20 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center mb-4">
                                    <svg class="h-10 w-10 text-primary-600 dark:text-primary-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                    </svg>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Redeem a Code</h3>
                                <p class="text-gray-600 dark:text-gray-400 mb-4">Enter a redemption code to unlock exclusive collectibles!</p>
                                <button onclick="switchView('redeemCode')" class="w-full py-2 px-4 bg-primary-600 hover:bg-primary-700 text-white rounded-md transition-colors">
                                    Enter Code
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden transition-all duration-300 hover:shadow-xl transform hover:scale-105">
                            <div class="p-6 flex flex-col items-center text-center">
                                <div class="w-20 h-20 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center mb-4">
                                    <svg class="h-10 w-10 text-primary-600 dark:text-primary-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                    </svg>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">View Collection</h3>
                                <p class="text-gray-600 dark:text-gray-400 mb-4">Browse your impressive collection of rare items</p>
                                <button onclick="switchView('collection')" class="w-full py-2 px-4 bg-primary-600 hover:bg-primary-700 text-white rounded-md transition-colors">
                                    View Collection
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            if (appState.codes.length === 0) {
                featuredContainer.innerHTML = `
                    <div class="col-span-full text-center p-8 text-gray-500 dark:text-gray-400 italic">
                        No featured collectibles to display
                    </div>
                `;
                return;
            }
            
            featuredContainer.innerHTML = '';
            
            const activeCodes = appState.codes.filter(code => code.is_active);
            
            if (activeCodes.length === 0) {
                featuredContainer.innerHTML = `
                    <div class="col-span-full text-center p-8 text-gray-500 dark:text-gray-400 italic">
                        No featured collectibles to display
                    </div>
                `;
                return;
            }
            
            const featuresToShow = activeCodes.slice(0, 3);
            
            featuresToShow.forEach(item => {
                let glitterHtml = '';
                if (item.rarity === 'legendary' || item.rarity === 'mythic') {
                    for (let i = 0; i < 5; i++) {
                        const top = Math.floor(Math.random() * 80) + 10;
                        const left = Math.floor(Math.random() * 80) + 10;
                        const delay = Math.random() * 2;
                        glitterHtml += `<div class="collectible-glitter" style="top: ${top}%; left: ${left}%; animation-delay: ${delay}s"></div>`;
                    }
                }
                
                const div = document.createElement('div');
                div.className = 'collectible-card relative bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow-lg transform transition-all duration-300 hover:shadow-xl';
                
                div.innerHTML = `
                    <div class="absolute inset-0 rarity-${item.rarity}"></div>
                    <div class="card-shine"></div>
                    <div class="card-border"></div>
                    ${glitterHtml}
                    <div class="relative p-6 flex flex-col items-center">
                        <div class="absolute top-4 right-4 bg-primary-500 text-white text-xs px-2 py-1 rounded-full shadow-sm">Admin View</div>
                        <div class="w-24 h-24 bg-white dark:bg-gray-700 rounded-full flex items-center justify-center mb-4 shadow-lg">
                            <div class="collectible-icon text-center text-4xl">
                                ${getEmojiByValue(item.item_graphic)}
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-1">${item.item_name}</h3>
                        <div class="mb-2">
                            <span class="badge-${item.rarity} rarity-badge">${item.rarity}</span>
                        </div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Code: ${item.code}</p>
                        <div class="mt-4 w-full">
                            <button class="w-full py-2 px-4 bg-primary-600 hover:bg-primary-700 text-white rounded-md transition-colors redeemFeaturedButton" data-code-id="${item.id}">
                                Edit Code
                            </button>
                        </div>
                    </div>
                `;
                
                featuredContainer.appendChild(div);
            });
            
            document.querySelectorAll('.redeemFeaturedButton').forEach(button => {
                button.addEventListener('click', (e) => {
                    const codeId = e.target.getAttribute('data-code-id');
                    switchView('adminPanel');
                    
                    setTimeout(() => {
                        const editButtons = document.querySelectorAll('.editCodeButton');
                        for (const button of editButtons) {
                            const buttonCodeId = button.getAttribute('data-code-id');
                            if (buttonCodeId === codeId) {
                                button.click();
                                break;
                            }
                        }
                    }, 100);
                });
            });
        }

        function renderWalletSummaryCards() {
            const container = document.getElementById('walletSummaryCards');
            if (!container) return;

            if (!appState.currentUser) {
                container.innerHTML = `
                    <div class="col-span-full bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-sm text-gray-500 dark:text-gray-400">
                        Sign in and redeem a few codes to unlock your realm economy overview.
                    </div>
                `;
                return;
            }

            const wallet = appState.wallet || {};
            const summary = appState.economySummary || {};
            const cards = [
                {
                    title: 'Realm Gold',
                    value: formatNumber(wallet.gold || 0),
                    subtitle: 'Spendable currency',
                    icon: '🪙',
                    accent: 'from-yellow-400/40 to-amber-500/30',
                    aria: 'Realm gold balance'
                },
                {
                    title: 'Stellar Gems',
                    value: formatNumber(wallet.gems || 0),
                    subtitle: 'Premium shards',
                    icon: '💎',
                    accent: 'from-purple-400/40 to-indigo-500/30',
                    aria: 'Stellar gem balance'
                },
                {
                    title: 'Aether Dust',
                    value: formatNumber(wallet.dust || 0),
                    subtitle: 'Crafting resource',
                    icon: '✨',
                    accent: 'from-sky-400/40 to-blue-500/30',
                    aria: 'Aether dust balance'
                },
                {
                    title: 'Daily Income',
                    value: `${formatNumber(summary.dailyIncome || 0)} / day`,
                    subtitle: 'Projected at current momentum',
                    icon: '📈',
                    accent: 'from-emerald-400/40 to-teal-500/30',
                    aria: 'Projected daily income'
                }
            ];

            container.innerHTML = cards.map(card => `
                <article class="relative overflow-hidden rounded-lg border border-gray-100 dark:border-gray-700/60 bg-white dark:bg-gray-800 shadow transition-transform transform hover:-translate-y-1 hover:shadow-lg" aria-label="${card.aria}">
                    <div class="absolute inset-0 bg-gradient-to-br ${card.accent} opacity-40 pointer-events-none"></div>
                    <div class="relative p-6 flex flex-col gap-4">
                        <div class="flex items-center justify-between">
                            <span class="text-3xl">${card.icon}</span>
                            <span class="text-xs uppercase tracking-wide text-gray-400 dark:text-gray-500">${card.subtitle}</span>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">${card.title}</p>
                            <p class="mt-1 text-2xl font-semibold text-gray-900 dark:text-white">${card.value}</p>
                        </div>
                    </div>
                </article>
            `).join('');
        }

        function renderEconomyPulse() {
            const panel = document.getElementById('economyPulsePanel');
            if (!panel) return;

            if (!appState.currentUser) {
                panel.innerHTML = `<div class="text-sm text-gray-500 dark:text-gray-400">Sign in to monitor your trading pulse.</div>`;
                return;
            }

            const summary = appState.economySummary || { dailyIncome: 0, tradePower: 0, barterScore: 0 };
            const wallet = appState.wallet || {};
            const completion = Math.min(100, Math.round((wallet.gold || 0) / (wallet.cap || 1) * 100));

            panel.innerHTML = `
                <div class="flex flex-col gap-6">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Economy Pulse</h2>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Live snapshot of your trading influence across the realm.</p>
                    </div>
                    <dl class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="p-4 rounded-lg bg-primary-50 dark:bg-primary-900/40 border border-primary-100 dark:border-primary-800/60">
                            <dt class="text-xs uppercase tracking-wide text-primary-600 dark:text-primary-300">Trade Power</dt>
                            <dd class="mt-2 text-xl font-semibold text-gray-900 dark:text-white">${formatNumber(summary.tradePower || 0)}</dd>
                            <dd class="text-xs text-gray-500 dark:text-gray-400">Combined value of currency and rare holdings</dd>
                        </div>
                        <div class="p-4 rounded-lg bg-white dark:bg-gray-900/40 border border-gray-100 dark:border-gray-700/60">
                            <dt class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Barter Score</dt>
                            <dd class="mt-2 text-xl font-semibold text-gray-900 dark:text-white">${formatNumber(summary.barterScore || 0)}</dd>
                            <dd class="text-xs text-gray-500 dark:text-gray-400">Higher scores unlock premium trading posts</dd>
                        </div>
                        <div class="p-4 rounded-lg bg-white dark:bg-gray-900/40 border border-gray-100 dark:border-gray-700/60">
                            <dt class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Vault Capacity</dt>
                            <dd class="mt-2 text-xl font-semibold text-gray-900 dark:text-white">${completion}%</dd>
                            <dd class="text-xs text-gray-500 dark:text-gray-400">${formatNumber(wallet.gold || 0)} / ${formatNumber(wallet.cap || 0)} gold stored</dd>
                        </div>
                    </dl>
                    <div>
                        <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-3 rounded-full bg-gradient-to-r from-primary-500 to-primary-400" style="width: ${completion}%;"></div>
                        </div>
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">Reach 100% to unlock vault expansion blueprints.</p>
                    </div>
                </div>
            `;
        }

        function renderLedgerEntries() {
            const ledgerContainer = document.getElementById('economyLedger');
            if (!ledgerContainer) return;

            const ledger = (appState.wallet?.ledger || []).slice(0, 20);
            if (!ledger.length) {
                ledgerContainer.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400">Complete redemptions, trades, or listings to build your ledger history.</p>`;
                return;
            }

            const typeIcons = {
                reward: '🎁',
                stipend: '🏦',
                purchase: '🛒',
                listing: '📣',
                reforge: '⚒️'
            };

            ledgerContainer.innerHTML = ledger.map(entry => {
                const delta = entry.delta || {};
                const gold = delta.gold ? `<span class="text-yellow-600 dark:text-yellow-300">${formatDelta(delta.gold, 'g')}</span>` : '';
                const gems = delta.gems ? `<span class="text-purple-600 dark:text-purple-300">${formatDelta(delta.gems, 'gem')}</span>` : '';
                const dust = delta.dust ? `<span class="text-blue-600 dark:text-blue-300">${formatDelta(delta.dust, 'dust')}</span>` : '';
                const changes = [gold, gems, dust].filter(Boolean).join(' · ') || '<span class="text-gray-400">0</span>';
                return `
                    <article class="flex items-start gap-3">
                        <div class="flex-shrink-0 h-10 w-10 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-lg">${typeIcons[entry.type] || '💠'}</div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 dark:text-white">${entry.description}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${formatRelativeTime(entry.created_at)}</p>
                        </div>
                        <div class="text-xs font-medium">${changes}</div>
                    </article>
                `;
            }).join('');
        }

        function renderMarketplaceStatsSummary() {
            const summaryNode = document.getElementById('marketStatsSummary');
            if (!summaryNode) return;

            const stats = appState.marketplace?.stats;
            if (!appState.currentUser) {
                summaryNode.textContent = 'Sign in to browse live offers and trading insights.';
                return;
            }

            if (!stats || !stats.totalListings) {
                summaryNode.textContent = 'Marketplace insights appear after syncing.';
                return;
            }

            const demandBreakdown = stats.demandSegments
                .map(segment => `${segment.count} ${segment.label}`)
                .join(' • ');
            const highlight = stats.highestValue
                ? `${stats.highestValue.name} (${formatNumber(stats.highestValue.value)} ${stats.highestValue.currency})`
                : 'No premium listings yet';

            summaryNode.textContent = `${stats.totalListings} listings live • Top item: ${highlight}${demandBreakdown ? ` • Demand: ${demandBreakdown}` : ''}`;
        }

        function renderMarketplaceSuggestions() {
            const container = document.getElementById('suggestedListings');
            if (!container) return;

            if (!appState.currentUser) {
                container.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400">Sign in to surface duplicates ready for trading.</p>`;
                return;
            }

            const suggestions = appState.marketplace?.suggestedListings || [];
            if (!suggestions.length) {
                container.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400">No duplicates detected yet. Redeem more codes or trade to discover listable items.</p>`;
                return;
            }

            container.innerHTML = suggestions.map(suggestion => `
                <div class="rounded-lg border border-gray-100 dark:border-gray-700/60 bg-white dark:bg-gray-800 p-4 shadow-sm">
                    <div class="flex items-start justify-between gap-3">
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">${renderEmoji(suggestion.item_graphic, 'text-2xl')}</span>
                                <div>
                                    <p class="text-sm font-semibold text-gray-900 dark:text-white">${suggestion.item_name}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">${suggestion.quantity} duplicate${suggestion.quantity > 1 ? 's' : ''} available</p>
                                </div>
                            </div>
                            <p class="mt-3 text-xs text-gray-500 dark:text-gray-400">Suggested price: ${formatNumber(suggestion.price)} gold${suggestion.altPrice ? ` • ${formatNumber(suggestion.altPrice)} gems` : ''}</p>
                        </div>
                        <span class="badge-${suggestion.rarity} rarity-badge">${suggestion.rarity}</span>
                    </div>
                    <button data-market-action="post" data-suggestion-id="${suggestion.id}" class="mt-4 w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-gray-900">List for ${formatNumber(suggestion.price)} gold</button>
                </div>
            `).join('');

            container.querySelectorAll('[data-market-action="post"]').forEach(button => {
                button.addEventListener('click', async () => {
                    const id = button.getAttribute('data-suggestion-id');
                    const suggestion = (appState.marketplace?.suggestedListings || []).find(item => item.id === id);
                    if (!suggestion) return;
                    const result = await Marketplace.postListing(suggestion);
                    if (result.success) {
                        showNotification(`${suggestion.item_name} posted to the marketplace!`, 'success');
                        renderMarketplaceView();
                        await updateDashboardStats();
                    } else {
                        showNotification('Unable to post listing at this time.', 'error');
                    }
                });
            });
        }

        function renderPlayerListings() {
            const container = document.getElementById('playerListings');
            if (!container) return;

            if (!appState.currentUser) {
                container.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400">Sign in to manage your listings.</p>`;
                return;
            }

            const listings = appState.marketplace?.playerListings || [];
            if (!listings.length) {
                container.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400">Post a duplicate to start your trading career.</p>`;
                return;
            }

            container.innerHTML = listings.map(listing => `
                <div class="rounded-lg border border-gray-100 dark:border-gray-700/60 bg-white dark:bg-gray-800 p-4 shadow-sm">
                    <div class="flex items-start justify-between gap-3">
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">${renderEmoji(listing.item_graphic, 'text-2xl')}</span>
                                <div>
                                    <p class="text-sm font-semibold text-gray-900 dark:text-white">${listing.item_name}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">${formatDate(listing.created_at)}</p>
                                </div>
                            </div>
                            <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">Asking ${formatNumber(listing.price)} gold${listing.altPrice ? ` • ${formatNumber(listing.altPrice)} gems` : ''}</p>
                        </div>
                        <span class="badge-${listing.rarity} rarity-badge">${listing.rarity}</span>
                    </div>
                    <button data-market-action="remove" data-listing-id="${listing.id}" class="mt-4 w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-gray-900">Remove Listing</button>
                </div>
            `).join('');

            container.querySelectorAll('[data-market-action="remove"]').forEach(button => {
                button.addEventListener('click', async () => {
                    const id = button.getAttribute('data-listing-id');
                    const result = await Marketplace.removeListing(id);
                    if (result.success) {
                        showNotification('Listing removed. You can repost it anytime.');
                        renderMarketplaceView();
                    } else {
                        showNotification('Unable to remove listing right now.', 'error');
                    }
                });
            });
        }

        function renderMarketplaceListings() {
            const container = document.getElementById('marketplaceListings');
            if (!container) return;

            if (!appState.currentUser) {
                container.innerHTML = `<div class="col-span-full text-sm text-gray-500 dark:text-gray-400 text-center py-6">Sign in to browse live marketplace offers.</div>`;
                return;
            }

            const listings = Marketplace.getFilteredListings();
            if (!listings.length) {
                container.innerHTML = `<div class="col-span-full text-sm text-gray-500 dark:text-gray-400 text-center py-6">No listings match your current filters. Adjust the filters or create a new listing.</div>`;
                return;
            }

            container.innerHTML = listings.map(listing => {
                const priceLabel = listing.currency === 'gems'
                    ? `${formatNumber(listing.price)} gems`
                    : `${formatNumber(listing.price)} gold`;
                const altCurrencyLabel = listing.currency === 'gems' ? 'gold' : 'gems';
                const altLabel = listing.altPrice ? ` • ${formatNumber(listing.altPrice)} ${altCurrencyLabel}` : '';
                const isPlayerListing = listing.origin === 'player' && listing.seller_id === appState.currentUser.id;
                const actionLabel = isPlayerListing ? 'Manage Listing' : 'Purchase';
                const action = isPlayerListing ? 'manage' : 'purchase';
                return `
                    <article class="relative overflow-hidden rounded-lg border border-gray-100 dark:border-gray-700/60 bg-white dark:bg-gray-800 p-6 shadow-sm transition-transform transform hover:-translate-y-1 hover:shadow-lg">
                        <div class="flex items-start justify-between gap-3">
                            <div>
                                <div class="flex items-center gap-3">
                                    <span class="text-3xl">${renderEmoji(listing.item_graphic, 'text-3xl')}</span>
                                    <div>
                                        <h3 class="text-base font-semibold text-gray-900 dark:text-white">${listing.item_name}</h3>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">${formatRelativeTime(listing.created_at)} • ${listing.seller || 'Market Broker'}</p>
                                    </div>
                                </div>
                                <p class="mt-3 text-sm text-gray-600 dark:text-gray-300">${priceLabel}${altLabel}</p>
                            </div>
                            <span class="badge-${listing.rarity} rarity-badge">${listing.rarity}</span>
                        </div>
                        <button data-market-action="${action}" data-listing-id="${listing.id}" class="mt-6 w-full inline-flex items-center justify-center px-4 py-2 border ${action === 'purchase' ? 'border-transparent text-white bg-primary-600 hover:bg-primary-700' : 'border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700'} text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-gray-900">${actionLabel}</button>
                    </article>
                `;
            }).join('');

            container.querySelectorAll('[data-market-action="purchase"]').forEach(button => {
                button.addEventListener('click', async () => {
                    try {
                        const id = button.getAttribute('data-listing-id');
                        const result = await Marketplace.purchase(id);
                        if (!result.success) {
                            if (result.reason === 'insufficient') {
                                showNotification('Not enough currency for this purchase.', 'error');
                            } else {
                                showNotification('Unable to complete purchase right now.', 'error');
                            }
                            return;
                        }

                        const listing = result.listing;
                        const timestamp = new Date().toISOString();
                        const collectibleRecord = {
                            user_id: appState.currentUser.id,
                            item_name: listing.item_name,
                            item_graphic: listing.item_graphic,
                            rarity: listing.rarity,
                            acquired_date: timestamp,
                            code_id: null,
                            origin: 'marketplace',
                            metadata: { listing_id: listing.id }
                        };

                        await createCollectible(collectibleRecord);
                        appState.collectibles.push({
                            ...collectibleRecord,
                            id: `market-${Date.now()}`
                        });

                        const activityData = {
                            user_id: appState.currentUser.id,
                            action: 'traded',
                            item_name: listing.item_name,
                            item_rarity: listing.rarity,
                            created_at: timestamp
                        };

                        await createActivity(activityData);
                        appState.activities.unshift({
                            ...activityData,
                            id: `market-activity-${Date.now()}`
                        });

                        Engagement.sync();
                        Engagement.renderAll();
                        renderActivityFeed();
                        renderUserCollectionStats();
                        const activeFilter = document.getElementById('collectionFilterRarity')?.value || 'all';
                        renderCollection(activeFilter);
                        await Economy.sync({ reason: 'market-purchase' });
                        renderWalletSummaryCards();
                        renderEconomyPulse();
                        renderLedgerEntries();
                        renderMarketplaceView();
                        await updateDashboardStats();

                        showNotification(`${listing.item_name} secured! It has been added to your collection.`, 'success');
                    } catch (error) {
                        console.error('Error completing marketplace purchase', error);
                        showNotification('Unable to complete purchase right now.', 'error');
                    }
                });
            });

            container.querySelectorAll('[data-market-action="manage"]').forEach(button => {
                button.addEventListener('click', () => {
                    document.getElementById('playerListings')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });
        }

        function renderMarketplaceView() {
            renderWalletSummaryCards();
            renderEconomyPulse();
            renderLedgerEntries();
            renderMarketplaceStatsSummary();
            renderMarketplaceSuggestions();
            renderPlayerListings();
            renderMarketplaceListings();
        }

        function renderRedemptionHistory() {
            if (!appState.currentUser) return;

            const history = appState.redemptionHistory;
            const historyTable = document.getElementById('redemptionHistory');
            
            if (history.length === 0) {
                historyTable.innerHTML = `
                    <tr>
                        <td colspan="3" class="px-6 py-4 whitespace-nowrap text-center text-gray-500 dark:text-gray-400 italic">No redemption history</td>
                    </tr>
                `;
                return;
            }
            
            historyTable.innerHTML = '';
            
            history.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors';
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${formatDate(item.created_at)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${item.items.join(', ')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        <span class="badge-${item.rarity} rarity-badge">${item.rarity}</span>
                    </td>
                `;
                
                historyTable.appendChild(tr);
            });
        }

        async function renderAdminCodes() {
            const codesTable = document.getElementById('codesTable');
            
            if (appState.codes.length === 0) {
                codesTable.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-gray-500 dark:text-gray-400 italic">No codes created yet</td>
                    </tr>
                `;
                return;
            }
            
            codesTable.innerHTML = '';
            
            appState.codes.forEach(code => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors';
                
                const isExpired = code.expiration_date && new Date(code.expiration_date) < new Date();
                const statusClass = !code.is_active ? 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200' : 
                                    isExpired ? 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200' : 
                                    'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200';
                
                const statusText = !code.is_active ? 'Inactive' : 
                                isExpired ? 'Expired' : 
                                'Active';
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${code.code}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${code.item_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        <span class="badge-${code.rarity} rarity-badge">${code.rarity}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${code.expiration_date ? formatDate(code.expiration_date) : 'Never'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-code-id="${code.id}" class="editCodeButton text-primary-600 dark:text-primary-400 hover:text-primary-900 dark:hover:text-primary-300 mr-3">Edit</button>
                        <button data-code-id="${code.id}" class="toggleCodeButton ${code.is_active ? 'text-yellow-600 dark:text-yellow-400 hover:text-yellow-900 dark:hover:text-yellow-300' : 'text-green-600 dark:text-green-400 hover:text-green-900 dark:hover:text-green-300'} mr-3">${code.is_active ? 'Deactivate' : 'Activate'}</button>
                        <button data-code-id="${code.id}" class="deleteCodeButton text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300">Delete</button>
                    </td>
                `;
                
                codesTable.appendChild(tr);
            });
            
            // Add event listeners for code actions
            document.querySelectorAll('.toggleCodeButton').forEach(button => {
                button.addEventListener('click', async () => {
                    const codeId = button.getAttribute('data-code-id');
                    const code = appState.codes.find(c => c.id === codeId);
                    
                    if (code) {
                        try {
                            await updateCode(codeId, { is_active: !code.is_active });
                            code.is_active = !code.is_active;
                            renderAdminCodes();
                            showNotification(`Code ${code.code} ${code.is_active ? 'activated' : 'deactivated'} successfully`);
                        } catch (error) {
                            showNotification('Error updating code: ' + error.message, 'error');
                        }
                    }
                });
            });
            
            document.querySelectorAll('.deleteCodeButton').forEach(button => {
                button.addEventListener('click', () => {
                    const codeId = button.getAttribute('data-code-id');
                    const code = appState.codes.find(c => c.id === codeId);
                    
                    if (code) {
                        showConfirmation(
                            'Delete Code',
                            `Are you sure you want to delete the code "${code.code}"? This action cannot be undone.`,
                            'Delete',
                            async () => {
                                try {
                                    await deleteCode(codeId);
                                    appState.codes = appState.codes.filter(c => c.id !== codeId);
                                    renderAdminCodes();
                                    showNotification(`Code ${code.code} deleted successfully`);
                                } catch (error) {
                                    showNotification('Error deleting code: ' + error.message, 'error');
                                }
                            }
                        );
                    }
                });
            });
            
            document.querySelectorAll('.editCodeButton').forEach(button => {
                button.addEventListener('click', () => {
                    const codeId = button.getAttribute('data-code-id');
                    const code = appState.codes.find(c => c.id === codeId);
                    
                    if (code) {
                        document.getElementById('codeInput').value = code.code;
                        document.getElementById('itemNameInput').value = code.item_name;
                        
                        populateEmojiCategories();
                        selectAppropriateCategory(code.item_graphic);
                        
                        document.getElementById('itemRaritySelect').value = code.rarity;
                        document.getElementById('expirationDateInput').value = code.expiration_date || '';
                        
                        updateItemPreview();
                        
                        document.getElementById('createCodeModal').classList.remove('hidden');
                        document.getElementById('modal-title').textContent = 'Edit Redemption Code';
                        document.getElementById('createCodeConfirmButtonText').textContent = 'Save Changes';
                        
                        const confirmButton = document.getElementById('createCodeConfirmButton');
                        const newButton = confirmButton.cloneNode(true);
                        confirmButton.parentNode.replaceChild(newButton, confirmButton);
                        
                        newButton.addEventListener('click', async () => {
                            const spinner = document.getElementById('createCodeConfirmButtonSpinner');
                            const buttonText = document.getElementById('createCodeConfirmButtonText');
                            
                            spinner.classList.remove('hidden');
                            buttonText.textContent = 'Saving...';
                            newButton.disabled = true;
                            
                            try {
                                const updatedCode = {
                                    code: document.getElementById('codeInput').value.trim(),
                                    item_name: document.getElementById('itemNameInput').value.trim(),
                                    item_graphic: document.querySelector('.emoji-item.selected')?.getAttribute('data-value') || code.item_graphic,
                                    rarity: document.getElementById('itemRaritySelect').value,
                                    expiration_date: document.getElementById('expirationDateInput').value || null
                                };
                                
                                if (!updatedCode.code || !updatedCode.item_name) {
                                    throw new Error('Please fill in all required fields');
                                }
                                
                                await updateCode(codeId, updatedCode);
                                
                                const index = appState.codes.findIndex(c => c.id === codeId);
                                if (index !== -1) {
                                    appState.codes[index] = { ...appState.codes[index], ...updatedCode };
                                }
                                
                                document.getElementById('createCodeModal').classList.add('hidden');
                                renderAdminCodes();
                                showNotification(`Code ${updatedCode.code} updated successfully`);
                            } catch (error) {
                                showNotification(error.message, 'error');
                            } finally {
                                spinner.classList.add('hidden');
                                buttonText.textContent = 'Save Changes';
                                newButton.disabled = false;
                            }
                        });
                    }
                });
            });
        }

        function selectAppropriateCategory(itemGraphic) {
            let foundCategory = null;
            let foundEmoji = null;
            
            for (const category in emojiCategories) {
                const emoji = emojiCategories[category].find(e => e.value === itemGraphic);
                if (emoji) {
                    foundCategory = category;
                    foundEmoji = emoji;
                    break;
                }
            }
            
            if (foundCategory && foundEmoji) {
                document.getElementById('itemCategorySelect').value = foundCategory;
                updateEmojiGrid(foundCategory);
                
                const emojiItems = document.querySelectorAll('.emoji-item');
                emojiItems.forEach(item => {
                    if (item.getAttribute('data-value') === itemGraphic) {
                        item.classList.add('selected', 'bg-primary-100', 'dark:bg-primary-900');
                    }
                });
            }
        }

        async function renderAdminUsers() {
            const usersTable = document.getElementById('usersTable');
            
            if (appState.users.length === 0) {
                usersTable.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 whitespace-nowrap text-center text-gray-500 dark:text-gray-400 italic">No users found</td>
                    </tr>
                `;
                return;
            }
            
            usersTable.innerHTML = '';
            
            appState.users.forEach(user => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors';
                
                // Count user's collectibles - for simplicity, we'll show 0 for other users
                const collectiblesCount = user.id === appState.currentUser.id ? appState.collectibles.length : 0;
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10 rounded-full bg-primary-200 dark:bg-primary-800 flex items-center justify-center shadow-sm">
                                <span class="text-primary-700 dark:text-primary-300 font-medium">${user.username.charAt(0).toUpperCase()}</span>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900 dark:text-white">${user.username}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500 dark:text-gray-400">Hidden</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.role === 'admin' ? 'bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200' : 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200'}">
                            ${user.role.charAt(0).toUpperCase() + user.role.slice(1)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${collectiblesCount}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-user-id="${user.id}" class="viewUserButton text-primary-600 dark:text-primary-400 hover:text-primary-900 dark:hover:text-primary-300 mr-3">View</button>
                        <button data-user-id="${user.id}" class="toggleRoleButton ${user.role === 'admin' ? 'text-yellow-600 dark:text-yellow-400 hover:text-yellow-900 dark:hover:text-yellow-300' : 'text-purple-600 dark:text-purple-400 hover:text-purple-900 dark:hover:text-purple-300'} mr-3">${user.role === 'admin' ? 'Remove Admin' : 'Make Admin'}</button>
                    </td>
                `;
                
                usersTable.appendChild(tr);
            });
            
            document.querySelectorAll('.toggleRoleButton').forEach(button => {
                button.addEventListener('click', async () => {
                    const userId = button.getAttribute('data-user-id');
                    const user = appState.users.find(u => u.id === userId);
                    
                    if (user) {
                        if (user.id === appState.currentUser.id) {
                            showNotification('You cannot change your own role', 'error');
                            return;
                        }
                        
                        try {
                            const newRole = user.role === 'admin' ? 'user' : 'admin';
                            await updateUserProfile(userId, { role: newRole });
                            user.role = newRole;
                            renderAdminUsers();
                            showNotification(`User ${user.username} is now ${user.role}`);
                        } catch (error) {
                            showNotification('Error updating user role: ' + error.message, 'error');
                        }
                    }
                });
            });
            
            document.querySelectorAll('.viewUserButton').forEach(button => {
                button.addEventListener('click', () => {
                    const userId = button.getAttribute('data-user-id');
                    const user = appState.users.find(u => u.id === userId);
                    
                    if (user) {
                        const collectiblesCount = user.id === appState.currentUser.id ? appState.collectibles.length : 0;
                        
                        showConfirmation(
                            `User Details: ${user.username}`,
                            `Role: ${user.role}
                            Created: ${formatDate(user.created_at || new Date())}
                            Total Collectibles: ${collectiblesCount}`,
                            'Close',
                            () => {}
                        );
                    }
                });
            });
        }

        function renderProfileView() {
            if (!appState.currentUser) return;
            
            document.getElementById('profileUserInitial').textContent = appState.userProfile.username.charAt(0).toUpperCase();
            document.getElementById('profileUsername').textContent = appState.userProfile.username;
            document.getElementById('profileEmail').textContent = appState.currentUser.email;
            document.getElementById('profileRole').textContent = appState.userProfile.role.charAt(0).toUpperCase() + appState.userProfile.role.slice(1);
            
            const collectiblesCount = appState.collectibles.length;
            document.getElementById('profileCollectibles').textContent = collectiblesCount;
            
            document.getElementById('profileCreatedAt').textContent = formatDate(appState.userProfile.created_at || new Date());
            
            document.getElementById('updateUsername').value = appState.userProfile.username;
        }

        function renderSettingsView() {
            const settingsDarkModeToggle = document.getElementById('settingsDarkModeToggle');
            
            const isDarkMode = document.documentElement.classList.contains('dark');
            
            settingsDarkModeToggle.classList.toggle('bg-primary-500', isDarkMode);
            settingsDarkModeToggle.classList.toggle('bg-gray-200', !isDarkMode);
            settingsDarkModeToggle.querySelector('span').classList.toggle('translate-x-5', isDarkMode);
        }

        function updateItemPreview() {
            const itemName = document.getElementById('itemNameInput').value || 'Item Name';
            const selectedEmoji = document.querySelector('.emoji-item.selected');
            const itemGraphic = selectedEmoji ? selectedEmoji.getAttribute('data-value') : 'shield';
            const itemRarity = document.getElementById('itemRaritySelect').value;
            
            const previewContainer = document.getElementById('itemPreview');
            
            let glitterHtml = '';
            if (itemRarity === 'legendary' || itemRarity === 'mythic') {
                for (let i = 0; i < 5; i++) {
                    const top = Math.floor(Math.random() * 80) + 10;
                    const left = Math.floor(Math.random() * 80) + 10;
                    const delay = Math.random() * 2;
                    glitterHtml += `<div class="collectible-glitter" style="top: ${top}%; left: ${left}%; animation-delay: ${delay}s"></div>`;
                }
            }
            
            previewContainer.innerHTML = `
                <div class="collectible-card relative w-32 h-40 rounded-lg overflow-hidden shadow-md">
                    <div class="absolute inset-0 rarity-${itemRarity}"></div>
                    <div class="card-shine"></div>
                    <div class="card-border"></div>
                    ${glitterHtml}
                    <div class="relative flex flex-col items-center justify-center h-full p-2">
                        <div class="w-16 h-16 bg-white dark:bg-gray-700 rounded-full flex items-center justify-center shadow-sm">
                            <div class="collectible-icon text-center text-3xl">
                                ${getEmojiByValue(itemGraphic)}
                            </div>
                        </div>
                        <div class="mt-2 text-center">
                            <div class="font-medium text-xs text-gray-900 dark:text-white truncate max-w-full">${itemName}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                <span class="badge-${itemRarity} rarity-badge">${itemRarity}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateCode() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            const segments = 3;
            const segmentLength = 4;
            
            for (let s = 0; s < segments; s++) {
                for (let i = 0; i < segmentLength; i++) {
                    result += characters.charAt(Math.floor(Math.random() * characters.length));
                }
                if (s < segments - 1) result += '-';
            }
            
            return result;
        }

        function populateEmojiCategories() {
            const categorySelect = document.getElementById('itemCategorySelect');
            categorySelect.innerHTML = '';
            
            for (const category in emojiCategories) {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            }
            
            const firstCategory = Object.keys(emojiCategories)[0];
            updateEmojiGrid(firstCategory);
            
            categorySelect.addEventListener('change', (e) => {
                const selectedCategory = e.target.value;
                updateEmojiGrid(selectedCategory);
            });
            
            const searchInput = document.getElementById('emojiSearch');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                if (searchTerm.length === 0) {
                    updateEmojiGrid(categorySelect.value);
                } else {
                    searchEmojis(searchTerm);
                }
            });
        }
        
        function updateEmojiGrid(category) {
            const emojiPicker = document.getElementById('emojiPicker');
            emojiPicker.innerHTML = '';
            
            const emojis = emojiCategories[category];
            
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'emoji-category';
            
            const emojiGrid = document.createElement('div');
            emojiGrid.className = 'emoji-grid';
            
            emojis.forEach(emoji => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'emoji-item';
                emojiItem.setAttribute('data-value', emoji.value);
                emojiItem.innerHTML = `
                    <div class="emoji-icon">${emoji.emoji}</div>
                    <div class="emoji-name">${emoji.name}</div>
                `;
                
                emojiItem.addEventListener('click', () => {
                    document.querySelectorAll('.emoji-item').forEach(item => {
                        item.classList.remove('selected', 'bg-primary-100', 'dark:bg-primary-900');
                    });
                    
                    emojiItem.classList.add('selected', 'bg-primary-100', 'dark:bg-primary-900');
                    updateItemPreview();
                });
                
                emojiGrid.appendChild(emojiItem);
            });
            
            categoryDiv.appendChild(emojiGrid);
            emojiPicker.appendChild(categoryDiv);
        }
        
        function searchEmojis(searchTerm) {
            const emojiPicker = document.getElementById('emojiPicker');
            emojiPicker.innerHTML = '';
            
            const searchResults = [];
            
            for (const category in emojiCategories) {
                emojiCategories[category].forEach(emoji => {
                    if (emoji.name.toLowerCase().includes(searchTerm) || 
                        emoji.value.toLowerCase().includes(searchTerm) ||
                        category.toLowerCase().includes(searchTerm)) {
                        searchResults.push({ ...emoji, category });
                    }
                });
            }
            
            if (searchResults.length === 0) {
                emojiPicker.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 p-4">No emojis found matching "${searchTerm}"</p>`;
                return;
            }
            
            const groupedResults = {};
            searchResults.forEach(result => {
                if (!groupedResults[result.category]) {
                    groupedResults[result.category] = [];
                }
                groupedResults[result.category].push(result);
            });
            
            for (const category in groupedResults) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'emoji-category mb-4';
                
                const categoryTitle = document.createElement('h3');
                categoryTitle.className = 'text-sm font-medium text-gray-700 dark:text-gray-300 mb-2';
                categoryTitle.textContent = category;
                
                const emojiGrid = document.createElement('div');
                emojiGrid.className = 'emoji-grid';
                
                groupedResults[category].forEach(emoji => {
                    const emojiItem = document.createElement('div');
                    emojiItem.className = 'emoji-item';
                    emojiItem.setAttribute('data-value', emoji.value);
                    emojiItem.innerHTML = `
                        <div class="emoji-icon">${emoji.emoji}</div>
                        <div class="emoji-name">${emoji.name}</div>
                    `;
                    
                    emojiItem.addEventListener('click', () => {
                        document.querySelectorAll('.emoji-item').forEach(item => {
                            item.classList.remove('selected', 'bg-primary-100', 'dark:bg-primary-900');
                        });
                        
                        emojiItem.classList.add('selected', 'bg-primary-100', 'dark:bg-primary-900');
                        updateItemPreview();
                    });
                    
                    emojiGrid.appendChild(emojiItem);
                });
                
                categoryDiv.appendChild(categoryTitle);
                categoryDiv.appendChild(emojiGrid);
                emojiPicker.appendChild(categoryDiv);
            }
        }

        async function switchView(view) {
            // Hide all views
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('collectionView').classList.add('hidden');
            document.getElementById('redeemCodeView').classList.add('hidden');
            document.getElementById('marketplaceView').classList.add('hidden');
            document.getElementById('adminPanelView').classList.add('hidden');
            document.getElementById('profileView').classList.add('hidden');
            document.getElementById('settingsView').classList.add('hidden');
            
            // Show the requested view
            document.getElementById(`${view}View`).classList.remove('hidden');
            
            // Update navigation styling - desktop
            document.querySelectorAll('nav a').forEach(link => {
                link.classList.remove('border-primary-500', 'text-gray-900', 'dark:text-white');
                link.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-300');
            });
            
            if (['dashboard', 'collection', 'redeem', 'marketplace'].includes(view)) {
                document.getElementById(`nav-${view}`).classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-300');
                document.getElementById(`nav-${view}`).classList.add('border-primary-500', 'text-gray-900', 'dark:text-white');
            }
            
            // Update navigation styling - mobile
            document.querySelectorAll('#mobileMenu a').forEach(link => {
                link.classList.remove('bg-primary-50', 'dark:bg-primary-900', 'border-primary-500', 'text-primary-700', 'dark:text-primary-300');
                link.classList.add('border-transparent', 'text-gray-600', 'dark:text-gray-300');
            });
            
            if (['dashboard', 'collection', 'redeem', 'marketplace'].includes(view)) {
                document.getElementById(`mobile-nav-${view}`).classList.remove('border-transparent', 'text-gray-600', 'dark:text-gray-300');
                document.getElementById(`mobile-nav-${view}`).classList.add('bg-primary-50', 'dark:bg-primary-900', 'border-primary-500', 'text-primary-700', 'dark:text-primary-300');
            }

            stateStore.setState({ currentView: view }, `view:${view}`);
            
            // Perform view-specific initializations
            if (view === 'collection') {
                renderUserCollectionStats();
                renderCollection();
            } else if (view === 'dashboard') {
                Engagement.sync();
                await updateDashboardStats();
                Engagement.renderAll();
                renderActivityFeed();
                renderFeaturedCollectibles();
            } else if (view === 'marketplace') {
                await Economy.sync({ reason: 'view-marketplace' });
                await Marketplace.sync({ reason: 'view' });
                renderMarketplaceView();
            } else if (view === 'redeemCode') {
                renderRedemptionHistory();
            } else if (view === 'adminPanel') {
                await renderAdminCodes();
                await renderAdminUsers();
            } else if (view === 'profile') {
                renderProfileView();
            } else if (view === 'settings') {
                renderSettingsView();
            }
        }

        // Load all user data
        async function loadUserData() {
            if (!appState.currentUser) return;
            
            try {
                // Load user profile
                appState.userProfile = await getUserProfile(appState.currentUser.id);
                appState.isAdmin = appState.userProfile.role === 'admin';
                
                // Load user's collectibles
                appState.collectibles = await loadUserCollectibles(appState.currentUser.id);
                
                // Load user's activities
                appState.activities = await loadUserActivities(appState.currentUser.id);
                
                // Load user's redemption history
                appState.redemptionHistory = await loadUserRedemptionHistory(appState.currentUser.id);
                
                // Load codes (for featured collectibles and admin panel)
                appState.codes = await loadCodes();
                
                // Load all users if admin
                if (appState.isAdmin) {
                    appState.users = await getAllUsers();
                }

                Engagement.sync();

                return true;
            } catch (error) {
                console.error('Error loading user data:', error);
                showNotification('Error loading user data: ' + error.message, 'error');
                return false;
            }
        }

        // Event handlers
        function setupEventListeners() {
            // Dark mode toggle
            const darkModeToggles = [
                document.getElementById('darkModeToggle'),
                document.getElementById('headerDarkModeToggle'),
                document.getElementById('mobileDarkModeToggle')
            ];
            
            darkModeToggles.forEach(toggle => {
                if (toggle) {
                    toggle.addEventListener('click', () => {
                        const nextTheme = appState.theme === 'dark' ? 'light' : 'dark';
                        stateStore.setState({ theme: nextTheme }, 'theme:manual-toggle');
                    });
                }
            });
            
            // Navigation
            document.getElementById('nav-dashboard').addEventListener('click', (e) => {
                e.preventDefault();
                switchView('dashboard');
            });
            
            document.getElementById('nav-collection').addEventListener('click', (e) => {
                e.preventDefault();
                switchView('collection');
            });

            document.getElementById('nav-redeem').addEventListener('click', (e) => {
                e.preventDefault();
                switchView('redeemCode');
            });

            const marketplaceNav = document.getElementById('nav-marketplace');
            if (marketplaceNav) {
                marketplaceNav.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchView('marketplace');
                });
            }
            
            // Mobile navigation
            document.getElementById('mobile-nav-dashboard').addEventListener('click', (e) => {
                e.preventDefault();
                switchView('dashboard');
                document.getElementById('mobileMenu').classList.add('hidden');
            });
            
            document.getElementById('mobile-nav-collection').addEventListener('click', (e) => {
                e.preventDefault();
                switchView('collection');
                document.getElementById('mobileMenu').classList.add('hidden');
            });
            
            document.getElementById('mobile-nav-redeem').addEventListener('click', (e) => {
                e.preventDefault();
                switchView('redeemCode');
                document.getElementById('mobileMenu').classList.add('hidden');
            });

            const mobileMarketNav = document.getElementById('mobile-nav-marketplace');
            if (mobileMarketNav) {
                mobileMarketNav.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchView('marketplace');
                    document.getElementById('mobileMenu').classList.add('hidden');
                });
            }
            
            // Mobile menu toggle
            document.getElementById('mobileMenuButton').addEventListener('click', () => {
                const mobileMenu = document.getElementById('mobileMenu');
                mobileMenu.classList.toggle('hidden');
                
                const isExpanded = mobileMenu.classList.contains('hidden') ? 'false' : 'true';
                document.getElementById('mobileMenuButton').setAttribute('aria-expanded', isExpanded);
                
                const openIcon = document.getElementById('mobileMenuButton').querySelector('svg.block');
                const closeIcon = document.getElementById('mobileMenuButton').querySelector('svg.hidden');
                
                openIcon.classList.toggle('block');
                openIcon.classList.toggle('hidden');
                closeIcon.classList.toggle('block');
                closeIcon.classList.toggle('hidden');
            });
            
            // User menu toggle
            document.getElementById('userMenuButton').addEventListener('click', () => {
                document.getElementById('userMenu').classList.toggle('hidden');
            });
            
            // Handle clicks outside the user menu to close it
            document.addEventListener('click', (e) => {
                const userMenu = document.getElementById('userMenu');
                const userMenuButton = document.getElementById('userMenuButton');
                
                if (!userMenu.classList.contains('hidden') && 
                    !userMenuButton.contains(e.target) && 
                    !userMenu.contains(e.target)) {
                    userMenu.classList.add('hidden');
                }
            });
            
            // Collection filter
            document.getElementById('collectionFilterRarity').addEventListener('change', (e) => {
                renderCollection(e.target.value);
            });
            
            // Login/register toggle
            document.getElementById('showRegisterForm').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerForm').classList.remove('hidden');
            });
            
            document.getElementById('showLoginForm').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('loginForm').classList.remove('hidden');
            });
            
            // Login form
            document.getElementById('loginButton').addEventListener('click', async () => {
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    showNotification('Please enter both email and password', 'error');
                    return;
                }
                
                const spinner = document.getElementById('loginButtonSpinner');
                const buttonText = document.getElementById('loginButtonText');
                
                spinner.classList.remove('hidden');
                buttonText.textContent = 'Signing in...';
                document.getElementById('loginButton').disabled = true;
                
                try {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password,
                    });
                    
                    if (error) throw error;
                    
                    appState.currentUser = data.user;
                    
                    // Load user data
                    const dataLoaded = await loadUserData();
                    if (!dataLoaded) {
                        throw new Error('Failed to load user data');
                    }
                    
                    // Update UI for logged in user
                    document.getElementById('authScreen').classList.add('hidden');
                    document.getElementById('userInitial').textContent = appState.userProfile.username.charAt(0).toUpperCase();
                    document.getElementById('mobileUserInitial').textContent = appState.userProfile.username.charAt(0).toUpperCase();
                    document.getElementById('mobileUsername').textContent = appState.userProfile.username;
                    document.getElementById('mobileUserEmail').textContent = appState.currentUser.email;
                    
                    // Show admin panel link if user is admin
                    if (appState.isAdmin) {
                        document.getElementById('menu-admin-panel').classList.remove('hidden');
                        document.getElementById('mobile-menu-admin-panel').classList.remove('hidden');
                    } else {
                        document.getElementById('menu-admin-panel').classList.add('hidden');
                        document.getElementById('mobile-menu-admin-panel').classList.add('hidden');
                    }
                    
                    // Initialize dashboard
                    switchView('dashboard');
                    
                    showNotification(`Welcome back, ${appState.userProfile.username}!`);
                } catch (error) {
                    showNotification('Error signing in: ' + error.message, 'error');
                } finally {
                    spinner.classList.add('hidden');
                    buttonText.textContent = 'Sign In';
                    document.getElementById('loginButton').disabled = false;
                }
            });
            
            // Register form
            document.getElementById('registerButton').addEventListener('click', async () => {
                const username = document.getElementById('registerUsername').value.trim();
                const email = document.getElementById('registerEmail').value.trim();
                const password = document.getElementById('registerPassword').value;
                
                if (!username || !email || !password) {
                    showNotification('Please fill in all fields', 'error');
                    return;
                }
                
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showNotification('Please enter a valid email address', 'error');
                    return;
                }
                
                const spinner = document.getElementById('registerButtonSpinner');
                const buttonText = document.getElementById('registerButtonText');
                
                spinner.classList.remove('hidden');
                buttonText.textContent = 'Creating account...';
                document.getElementById('registerButton').disabled = true;
                
                try {
                    const { data, error } = await supabase.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: {
                                username: username
                            }
                        }
                    });
                    
                    if (error) throw error;
                    
                    if (data.user && !data.session) {
                        showNotification('Please check your email to confirm your account before signing in', 'error');
                        return;
                    }
                    
                    if (data.user && data.session) {
                        appState.currentUser = data.user;
                        
                        // Create user profile
                        await createUserProfile(data.user, username);
                        
                        // Load user data
                        const dataLoaded = await loadUserData();
                        if (!dataLoaded) {
                            throw new Error('Failed to load user data');
                        }
                        
                        // Update UI for logged in user
                        document.getElementById('authScreen').classList.add('hidden');
                        document.getElementById('userInitial').textContent = username.charAt(0).toUpperCase();
                        document.getElementById('mobileUserInitial').textContent = username.charAt(0).toUpperCase();
                        document.getElementById('mobileUsername').textContent = username;
                        document.getElementById('mobileUserEmail').textContent = email;
                        
                        // Hide admin panel link for new users
                        document.getElementById('menu-admin-panel').classList.add('hidden');
                        document.getElementById('mobile-menu-admin-panel').classList.add('hidden');
                        
                        // Initialize dashboard
                        switchView('dashboard');
                        
                        showNotification(`Welcome to Collectible Realm, ${username}!`);
                    }
                } catch (error) {
                    showNotification('Error creating account: ' + error.message, 'error');
                } finally {
                    spinner.classList.add('hidden');
                    buttonText.textContent = 'Register';
                    document.getElementById('registerButton').disabled = false;
                }
            });

            // Redeem code button
            document.getElementById('redeemCodeButton').addEventListener('click', async () => {
                const codeInput = document.getElementById('redeemCode').value.trim();
                const resultDiv = document.getElementById('redeemResult');
                
                if (!codeInput) {
                    resultDiv.innerHTML = 'Please enter a code';
                    resultDiv.className = 'mt-4 p-4 rounded-md bg-red-50 dark:bg-red-900 text-red-800 dark:text-red-100';
                    resultDiv.classList.remove('hidden');
                    return;
                }
                
                const spinner = document.getElementById('redeemCodeButtonSpinner');
                const buttonText = document.getElementById('redeemCodeButtonText');
                
                spinner.classList.remove('hidden');
                buttonText.textContent = 'Redeeming...';
                document.getElementById('redeemCodeButton').disabled = true;
                
                try {
                    // Check if code exists and is valid
                    const code = appState.codes.find(c => c.code === codeInput);
                    
                    if (!code) {
                        throw new Error('Invalid code. Please check and try again.');
                    }
                    
                    if (!code.is_active) {
                        throw new Error('This code is no longer active.');
                    }
                    
                    if (code.expiration_date && new Date(code.expiration_date) < new Date()) {
                        throw new Error('This code has expired.');
                    }
                    
                    // Check if user already redeemed this code
                    const alreadyRedeemed = appState.collectibles.some(c => c.code_id === code.id);
                    
                    if (alreadyRedeemed) {
                        throw new Error('You have already redeemed this code.');
                    }
                    
                    // Redeem the code
                    const newCollectible = {
                        user_id: appState.currentUser.id,
                        item_name: code.item_name,
                        item_graphic: code.item_graphic,
                        rarity: code.rarity,
                        code_id: code.id
                    };
                    
                    await createCollectible(newCollectible);
                    
                    // Add to redemption history
                    const redemptionData = {
                        user_id: appState.currentUser.id,
                        code: code.code,
                        items: [code.item_name],
                        rarity: code.rarity
                    };
                    
                    await createRedemptionHistory(redemptionData);
                    
                    // Add to activities
                    const activityData = {
                        user_id: appState.currentUser.id,
                        action: 'redeemed',
                        item_name: code.item_name,
                        item_rarity: code.rarity
                    };
                    
                    await createActivity(activityData);
                    
                    // Update local state
                    appState.collectibles.push({
                        ...newCollectible,
                        id: 'temp-' + Date.now(), // Temporary ID
                        acquired_date: new Date().toISOString()
                    });
                    
                    appState.redemptionHistory.push({
                        ...redemptionData,
                        id: 'temp-' + Date.now(),
                        created_at: new Date().toISOString()
                    });
                    
                    appState.activities.unshift({
                        ...activityData,
                        id: 'temp-' + Date.now(),
                        created_at: new Date().toISOString()
                    });

                    Engagement.sync();
                    Engagement.renderAll();
                    await updateDashboardStats();
                    renderActivityFeed();
                    renderUserCollectionStats();
                    const activeCollectionFilter = document.getElementById('collectionFilterRarity')?.value || 'all';
                    renderCollection(activeCollectionFilter);

                    // Create glitter elements for legendary and mythic items
                    let glitterHtml = '';
                    if (code.rarity === 'legendary' || code.rarity === 'mythic') {
                        for (let i = 0; i < 8; i++) {
                            const top = Math.floor(Math.random() * 80) + 10;
                            const left = Math.floor(Math.random() * 80) + 10;
                            const delay = Math.random() * 2;
                            glitterHtml += `<div class="collectible-glitter" style="top: ${top}%; left: ${left}%; animation-delay: ${delay}s"></div>`;
                        }
                    }
                    
                    // Update UI with an enhanced and animated redemption result
                    resultDiv.innerHTML = `
                        <div class="flex flex-col items-center">
                            <div class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                <span class="flex items-center">
                                    <svg class="h-6 w-6 mr-2 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    Code redeemed successfully!
                                </span>
                            </div>
                            <div class="collectible-card redeemed-collectible relative w-40 h-52 rounded-lg overflow-hidden shadow-lg mb-5">
                                <div class="absolute inset-0 rarity-${code.rarity}"></div>
                                <div class="card-shine"></div>
                                <div class="card-border"></div>
                                ${glitterHtml}
                                <div class="relative flex flex-col items-center justify-center h-full p-3">
                                    <div class="w-24 h-24 bg-white dark:bg-gray-700 rounded-full flex items-center justify-center mb-3 shadow-lg">
                                        <div class="collectible-icon text-center text-4xl">
                                            ${getEmojiByValue(code.item_graphic)}
                                        </div>
                                    </div>
                                    <h3 class="text-base font-semibold text-gray-900 dark:text-white mb-1">${code.item_name}</h3>
                                    <div class="mb-1">
                                        <span class="badge-${code.rarity} rarity-badge">${code.rarity}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-3 w-full max-w-xs">
                                <button onclick="switchView('collection')" class="flex-1 px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-md transition-colors">
                                    View Collection
                                </button>
                                <button id="redeemAnotherBtn" class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-white rounded-md transition-colors">
                                    Redeem Another
                                </button>
                            </div>
                        </div>
                    `;
                    resultDiv.className = 'mt-4 p-6 rounded-md bg-green-50 dark:bg-green-900 text-green-800 dark:text-green-100';
                    resultDiv.classList.remove('hidden');
                    
                    // Clear the input
                    document.getElementById('redeemCode').value = '';
                    
                    // Update redemption history
                    renderRedemptionHistory();
                    
                    // Add event listener to "Redeem Another" button
                    document.getElementById('redeemAnotherBtn').addEventListener('click', () => {
                        document.getElementById('redeemResult').classList.add('hidden');
                        document.getElementById('redeemCode').focus();
                    });
                    
                    // Show notification
                    showNotification(`You've successfully redeemed ${code.item_name}!`);
                    
                } catch (error) {
                    resultDiv.innerHTML = error.message;
                    resultDiv.className = 'mt-4 p-4 rounded-md bg-red-50 dark:bg-red-900 text-red-800 dark:text-red-100';
                    resultDiv.classList.remove('hidden');
                } finally {
                    spinner.classList.add('hidden');
                    buttonText.textContent = 'Redeem Code';
                    document.getElementById('redeemCodeButton').disabled = false;
                }
            });

            // Admin panel - create code button
            document.getElementById('createCodeButton').addEventListener('click', () => {
                document.getElementById('codeInput').value = '';
                document.getElementById('itemNameInput').value = '';
                document.getElementById('itemRaritySelect').value = 'common';
                document.getElementById('expirationDateInput').value = '';
                
                populateEmojiCategories();
                updateItemPreview();
                
                document.getElementById('modal-title').textContent = 'Create New Redemption Code';
                document.getElementById('createCodeConfirmButtonText').textContent = 'Create';
                
                document.getElementById('createCodeModal').classList.remove('hidden');
                
                const confirmButton = document.getElementById('createCodeConfirmButton');
                const newButton = confirmButton.cloneNode(true);
                confirmButton.parentNode.replaceChild(newButton, confirmButton);
                
                newButton.addEventListener('click', async () => {
                    const code = document.getElementById('codeInput').value.trim();
                    const itemName = document.getElementById('itemNameInput').value.trim();
                    const selectedEmoji = document.querySelector('.emoji-item.selected');
                    const itemGraphic = selectedEmoji ? selectedEmoji.getAttribute('data-value') : 'shield';
                    const itemRarity = document.getElementById('itemRaritySelect').value;
                    const expirationDate = document.getElementById('expirationDateInput').value || null;
                    
                    if (!code || !itemName) {
                        showNotification('Please fill in all required fields', 'error');
                        return;
                    }
                    
                    if (appState.codes.some(c => c.code === code)) {
                        showNotification('This code already exists', 'error');
                        return;
                    }
                    
                    const spinner = document.getElementById('createCodeConfirmButtonSpinner');
                    const buttonText = document.getElementById('createCodeConfirmButtonText');
                    
                    spinner.classList.remove('hidden');
                    buttonText.textContent = 'Creating...';
                    newButton.disabled = true;
                    
                    try {
                        const newCode = {
                            code,
                            item_name: itemName,
                            item_graphic: itemGraphic,
                            rarity: itemRarity,
                            expiration_date: expirationDate,
                            is_active: true
                        };
                        
                        await createCode(newCode);
                        
                        appState.codes.unshift({
                            ...newCode,
                            id: 'temp-' + Date.now(),
                            created_at: new Date().toISOString()
                        });
                        
                        document.getElementById('createCodeModal').classList.add('hidden');
                        renderAdminCodes();
                        showNotification(`Code ${code} created successfully`);
                    } catch (error) {
                        showNotification('Error creating code: ' + error.message, 'error');
                    } finally {
                        spinner.classList.add('hidden');
                        buttonText.textContent = 'Create';
                        newButton.disabled = false;
                    }
                });
            });
            
            // Generate random code
            document.getElementById('generateCodeButton').addEventListener('click', () => {
                document.getElementById('codeInput').value = generateCode();
            });
            
            // Admin panel modal close button
            document.getElementById('createCodeCancelButton').addEventListener('click', () => {
                document.getElementById('createCodeModal').classList.add('hidden');
            });
            
            // Collectible detail modal close button
            document.getElementById('collectibleDetailCloseButton').addEventListener('click', () => {
                document.getElementById('collectibleDetailModal').classList.add('hidden');
            });
            
            // Item preview live update
            document.getElementById('itemNameInput').addEventListener('input', updateItemPreview);
            document.getElementById('itemRaritySelect').addEventListener('change', updateItemPreview);
            
            // Admin panel link
            document.getElementById('menu-admin-panel').addEventListener('click', (e) => {
                e.preventDefault();
                if (appState.isAdmin) {
                    switchView('adminPanel');
                    document.getElementById('userMenu').classList.add('hidden');
                } else {
                    showNotification('You do not have admin privileges', 'error');
                }
            });
            
            document.getElementById('mobile-menu-admin-panel').addEventListener('click', (e) => {
                e.preventDefault();
                if (appState.isAdmin) {
                    switchView('adminPanel');
                    document.getElementById('mobileMenu').classList.add('hidden');
                } else {
                    showNotification('You do not have admin privileges', 'error');
                }
            });

            // Profile menu items
            document.getElementById('menu-profile').addEventListener('click', (e) => {
                e.preventDefault();
                switchView('profile');
                document.getElementById('userMenu').classList.add('hidden');
            });
            
            document.getElementById('mobile-menu-profile').addEventListener('click', (e) => {
                e.preventDefault();
                switchView('profile');
                document.getElementById('mobileMenu').classList.add('hidden');
            });
            
            // Settings menu items
            document.getElementById('menu-settings').addEventListener('click', (e) => {
                e.preventDefault();
                switchView('settings');
                document.getElementById('userMenu').classList.add('hidden');
            });
            
            document.getElementById('mobile-menu-settings').addEventListener('click', (e) => {
                e.preventDefault();
                switchView('settings');
                document.getElementById('mobileMenu').classList.add('hidden');
            });
            
            // Update profile button
            document.getElementById('updateProfileButton').addEventListener('click', async () => {
                const newUsername = document.getElementById('updateUsername').value.trim();
                
                if (!newUsername) {
                    showNotification('Username is required', 'error');
                    return;
                }
                
                const spinner = document.getElementById('updateProfileButtonSpinner');
                const buttonText = document.getElementById('updateProfileButtonText');
                
                spinner.classList.remove('hidden');
                buttonText.textContent = 'Updating...';
                document.getElementById('updateProfileButton').disabled = true;
                
                try {
                    await updateUserProfile(appState.currentUser.id, { username: newUsername });
                    
                    // Update local state
                    appState.userProfile.username = newUsername;
                    
                    // Update the UI
                    document.getElementById('userInitial').textContent = newUsername.charAt(0).toUpperCase();
                    document.getElementById('mobileUserInitial').textContent = newUsername.charAt(0).toUpperCase();
                    document.getElementById('mobileUsername').textContent = newUsername;
                    
                    // Update profile view
                    renderProfileView();
                    
                    showNotification('Profile updated successfully');
                } catch (error) {
                    showNotification('Error updating profile: ' + error.message, 'error');
                } finally {
                    spinner.classList.add('hidden');
                    buttonText.textContent = 'Update Profile';
                    document.getElementById('updateProfileButton').disabled = false;
                }
            });
            
            // Settings toggles
            document.getElementById('settingsDarkModeToggle').addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const isDarkMode = document.documentElement.classList.contains('dark');
                
                // Update toggle appearance
                document.getElementById('settingsDarkModeToggle').classList.toggle('bg-primary-500', isDarkMode);
                document.getElementById('settingsDarkModeToggle').classList.toggle('bg-gray-200', !isDarkMode);
                document.getElementById('settingsDarkModeToggle').querySelector('span').classList.toggle('translate-x-5', isDarkMode);
            });
            
            // Data management
            document.getElementById('exportDataButton').addEventListener('click', async () => {
                try {
                    const exportData = {
                        user: {
                            username: appState.userProfile.username,
                            email: appState.currentUser.email,
                            createdAt: appState.userProfile.created_at
                        },
                        collectibles: appState.collectibles,
                        redemptionHistory: appState.redemptionHistory,
                        activities: appState.activities,
                        wallet: appState.wallet,
                        economySummary: appState.economySummary,
                        marketplace: {
                            playerListings: appState.marketplace.playerListings,
                            suggestedListings: appState.marketplace.suggestedListings,
                            filters: appState.marketplace.filters
                        },
                        exportDate: new Date().toISOString()
                    };
                    
                    showConfirmation(
                        'Export Data',
                        'Your data is ready for export. In a real application, you would be able to download this as a file.',
                        'Close',
                        () => {}
                    );
                } catch (error) {
                    showNotification('Error exporting data: ' + error.message, 'error');
                }
            });
            
            document.getElementById('clearDataButton').addEventListener('click', () => {
                showConfirmation(
                    'Clear All Data',
                    'Are you sure you want to clear all your data? This will remove all your collectibles, redemption history, and activities. This action cannot be undone.',
                    'Clear Data',
                    async () => {
                        try {
                            // In a real implementation, you'd need to delete from the database
                            // For now, we'll just clear the local state
                            appState.collectibles = [];
                            appState.redemptionHistory = [];
                            appState.activities = [];

                            Engagement.sync();
                            Engagement.renderAll();
                            await updateDashboardStats();
                            renderActivityFeed();
                            renderRedemptionHistory();
                            renderUserCollectionStats();
                            const resetCollectionFilter = document.getElementById('collectionFilterRarity')?.value || 'all';
                            renderCollection(resetCollectionFilter);

                            switchView('dashboard');
                            showNotification('All your data has been cleared');
                        } catch (error) {
                            showNotification('Error clearing data: ' + error.message, 'error');
                        }
                    }
                );
            });

            // Logout
            document.getElementById('menu-sign-out').addEventListener('click', async (e) => {
                e.preventDefault();
                await logout();
            });
            
            document.getElementById('mobile-menu-sign-out').addEventListener('click', async (e) => {
                e.preventDefault();
                await logout();
            });

            const claimStipendButton = document.getElementById('claimStipendButton');
            if (claimStipendButton) {
                claimStipendButton.addEventListener('click', async () => {
                    const result = await Economy.grantDailyStipend();
                    if (result.success) {
                        showNotification('Daily stipend claimed! Check your wallet for the boost.', 'success');
                        await Economy.sync({ reason: 'stipend' });
                        renderMarketplaceView();
                        await updateDashboardStats();
                    } else if (result.reason === 'already-claimed') {
                        showNotification('Daily stipend already claimed. Come back tomorrow.', 'error');
                    } else {
                        showNotification('Unable to grant stipend right now.', 'error');
                    }
                });
            }

            const convertDuplicatesButton = document.getElementById('convertDuplicatesButton');
            if (convertDuplicatesButton) {
                convertDuplicatesButton.addEventListener('click', async () => {
                    const result = await Economy.convertDuplicatesToDust();
                    if (result.success) {
                        showNotification(`Converted ${result.duplicatesProcessed} duplicate sets into ${formatNumber(result.dustAward)} dust.`, 'success');
                        await Marketplace.sync({ reason: 'duplicate-conversion' });
                        renderMarketplaceView();
                        await updateDashboardStats();
                    } else if (result.reason === 'no-duplicates') {
                        showNotification('No duplicates available for conversion yet.', 'error');
                    } else {
                        showNotification('Unable to convert duplicates at this time.', 'error');
                    }
                });
            }

            const refreshSuggestionsButton = document.getElementById('refreshMarketplaceSuggestions');
            if (refreshSuggestionsButton) {
                refreshSuggestionsButton.addEventListener('click', async () => {
                    await Marketplace.sync({ reason: 'refresh-suggestions' });
                    renderMarketplaceSuggestions();
                });
            }

            const marketFilterRarity = document.getElementById('marketFilterRarity');
            if (marketFilterRarity) {
                marketFilterRarity.addEventListener('change', (event) => {
                    Marketplace.updateFilters({ rarity: event.target.value });
                    renderMarketplaceListings();
                    renderMarketplaceStatsSummary();
                });
            }

            const marketFilterCurrency = document.getElementById('marketFilterCurrency');
            if (marketFilterCurrency) {
                marketFilterCurrency.addEventListener('change', (event) => {
                    Marketplace.updateFilters({ currency: event.target.value });
                    renderMarketplaceListings();
                    renderMarketplaceStatsSummary();
                });
            }

            const marketFilterSort = document.getElementById('marketFilterSort');
            if (marketFilterSort) {
                marketFilterSort.addEventListener('change', (event) => {
                    Marketplace.updateFilters({ sort: event.target.value });
                    renderMarketplaceListings();
                });
            }
        }

        async function logout() {
            try {
                await supabase.auth.signOut();
                
                // Clear application state
                appState.currentUser = null;
                appState.userProfile = null;
                appState.isAdmin = false;
                appState.codes = [];
                appState.collectibles = [];
                appState.activities = [];
                appState.redemptionHistory = [];
                appState.users = [];
                appState.progression = null;
                appState.quests = [];
                appState.achievements = [];
                appState.seasonEvents = [];
                appState.journeyInsights = null;

                Engagement.sync();
                Engagement.renderAll();
                await updateDashboardStats();
                renderActivityFeed();
                renderRedemptionHistory();
                renderUserCollectionStats();

                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('authScreen').classList.add('flex');
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('userMenu').classList.add('hidden');
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                
                showNotification('You have been signed out');
            } catch (error) {
                showNotification('Error signing out: ' + error.message, 'error');
            }
        }

        // Initialize the application
        async function initApp() {
            if (SUPABASE_URL === 'YOUR_SUPABASE_PROJECT_URL_HERE' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
                document.getElementById('loadingScreen').classList.add('hidden');
                showNotification('Please configure your Supabase credentials in the code', 'error');
                return;
            }
            
            // Setup event listeners
            setupEventListeners();
            
            try {
                // Check if user is already signed in
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session?.user) {
                    appState.currentUser = session.user;
                    
                    // Load user data
                    const dataLoaded = await loadUserData();
                    if (dataLoaded) {
                        // User is logged in and data loaded successfully
                        document.getElementById('userInitial').textContent = appState.userProfile.username.charAt(0).toUpperCase();
                        document.getElementById('mobileUserInitial').textContent = appState.userProfile.username.charAt(0).toUpperCase();
                        document.getElementById('mobileUsername').textContent = appState.userProfile.username;
                        document.getElementById('mobileUserEmail').textContent = appState.currentUser.email;
                        
                        // Show admin panel link if user is admin
                        if (appState.isAdmin) {
                            document.getElementById('menu-admin-panel').classList.remove('hidden');
                            document.getElementById('mobile-menu-admin-panel').classList.remove('hidden');
                        } else {
                            document.getElementById('menu-admin-panel').classList.add('hidden');
                            document.getElementById('mobile-menu-admin-panel').classList.add('hidden');
                        }
                        
                        // Show dashboard
                        document.getElementById('loadingScreen').classList.add('hidden');
                        switchView('dashboard');
                    } else {
                        // Failed to load user data, show auth screen
                        document.getElementById('loadingScreen').classList.add('hidden');
                        document.getElementById('authScreen').classList.remove('hidden');
                        document.getElementById('authScreen').classList.add('flex');
                    }
                } else {
                    // No user is logged in
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('authScreen').classList.remove('hidden');
                    document.getElementById('authScreen').classList.add('flex');
                }
            } catch (error) {
                console.error('Error initializing app:', error);
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('authScreen').classList.add('flex');
                showNotification('Error loading application: ' + error.message, 'error');
            }
        }

        // Start the app after a short delay to simulate loading
        setTimeout(initApp, 1000);
    </script>

    <script type="application/sql" id="supabase-schema">
create extension if not exists "uuid-ossp";

create table if not exists user_wallets (
    user_id uuid primary key references user_profiles(id) on delete cascade,
    gold numeric default 0,
    gems numeric default 0,
    dust numeric default 0,
    cap numeric default 250000,
    last_stipend_at date,
    metadata jsonb default '{}'::jsonb,
    updated_at timestamptz default now()
);

create table if not exists wallet_ledger (
    id uuid primary key default uuid_generate_v4(),
    user_id uuid references user_profiles(id) on delete cascade,
    entry_type text not null,
    description text not null,
    delta_gold numeric default 0,
    delta_gems numeric default 0,
    delta_dust numeric default 0,
    metadata jsonb default '{}'::jsonb,
    created_at timestamptz default now()
);

create index if not exists wallet_ledger_user_created_idx on wallet_ledger(user_id, created_at desc);

create table if not exists marketplace_listings (
    id uuid primary key default uuid_generate_v4(),
    seller_id uuid references user_profiles(id) on delete set null,
    seller_display_name text,
    item_name text not null,
    item_graphic text not null,
    rarity text not null,
    price_gold numeric default 0,
    price_gems numeric default 0,
    currency_primary text not null default 'gold',
    currency_secondary text not null default 'gems',
    demand text,
    status text not null default 'available',
    origin text not null default 'player',
    metadata jsonb default '{}'::jsonb,
    created_at timestamptz default now(),
    updated_at timestamptz default now()
);

create index if not exists marketplace_listings_seller_idx on marketplace_listings(seller_id, created_at desc);
create index if not exists marketplace_listings_origin_status_idx on marketplace_listings(origin, status);

create table if not exists marketplace_transactions (
    id uuid primary key default uuid_generate_v4(),
    listing_id uuid references marketplace_listings(id) on delete set null,
    buyer_id uuid references user_profiles(id) on delete set null,
    seller_id uuid references user_profiles(id) on delete set null,
    price_gold numeric default 0,
    price_gems numeric default 0,
    currency_primary text not null,
    currency_secondary text not null,
    description text,
    metadata jsonb default '{}'::jsonb,
    created_at timestamptz default now()
);

create view if not exists marketplace_transactions_view as
select
    coalesce(sum(price_gold), 0) as recent_volume_gold,
    coalesce(sum(price_gems), 0) as recent_volume_gems,
    (select currency_primary from marketplace_transactions group by currency_primary order by count(*) desc limit 1) as top_currency
from marketplace_transactions
where created_at > now() - interval '7 days';

alter table collectibles
    add column if not exists origin text default 'code',
    add column if not exists metadata jsonb default '{}'::jsonb;

alter table user_wallets
    add column if not exists metadata jsonb default '{}'::jsonb;
    </script>
</body>
</html>
